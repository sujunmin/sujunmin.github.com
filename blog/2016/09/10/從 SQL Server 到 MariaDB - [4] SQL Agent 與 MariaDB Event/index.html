<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>從 SQL Server 到 MariaDB - [4] SQL Agent 與 MariaDB Event | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>從 SQL Server 到 MariaDB - [4] SQL Agent 與 MariaDB Event</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-09-10</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a>/<a class="post-tag-link" href="/blog/tags/MariaDB/">MariaDB</a></div></div></div><article><div class="container post"><h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>回到維運面的處理，在 SQL Server 有 SQL Server Agent Service 作為 Job System，說實在真的好用，在 msdb 裡儲存了很多 Job 的資料，不管是統計還是錯誤時的資料收集都做的非常好，因此系統每天會出資料庫系統狀態報表，其中有兩個項目有很多東西能看</p>
<p><img src="https://raw.githubusercontent.com/sujunmin/sujunmin.github.com/master/test/SQLServerAgentLog_1.png"><br><img src="https://raw.githubusercontent.com/sujunmin/sujunmin.github.com/master/test/SQLServerAgentLog_2.png"> </p>
<p>因此每天的檢查大部份都是看這些 Log 的狀態，希望在 MariaDB 上面希望也有類似的方法實作。</p>
<h2 id="Job-System-的選擇"><a href="#Job-System-的選擇" class="headerlink" title="Job System 的選擇"></a>Job System 的選擇</h2><p>在 MariaDB 上有 <figure class="highlight plain"><figcaption><span>可以用，在 Windows 裡有 Windows Tasks 可以用，但他們跟 SQL Server Agent Service 真的是差太多了，這兩個服務 MariaDB 的 ```Event``` 幾乎是射後不理，Windows 的 Tasks 也只有少少的 Log 可以用，基本上直接用是沒法達到原來維運的要求的，最後仍然是選擇 MariaDB 的 ```Event``` 配合一點紀錄來實作 Job System。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## MariaDB 的 ```Event</div></pre></td></tr></table></figure></p>
<p>詳細資料可以參考<a href="https://mariadb.com/kb/en/mariadb/events/" target="_blank" rel="external">這個</a>，基本上很簡單，就是設定某個 Schema 的什麼時候做什麼事情，用 <figure class="highlight plain"><figcaption><span>events;``` 可以看到 ```Event``` 的內容，不過這邊要來說明的是 ```mysql.event``` 這個[資料表](https://mariadb.com/kb/en/mariadb/mysqlevent-table/)，因為所有的 ```Event``` 資料都是從這個地方加工的。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">其中有一些時間戳記，經過一些實驗結果 (因為真的寫的好少，不太清楚真正的意思) 有一些認識</div><div class="line"></div><div class="line">|  欄位名              | 意義                                              | </div><div class="line">|---------------------|--------------------------------------------------|</div><div class="line">| ```created```       | ```Event``` 產生的時間                             |</div><div class="line">| ```modified```      | ```Event``` 被修改的時間                           |</div><div class="line">| ```last_executed``` | 上次執行結束時間 (不論成功或失敗)                     |</div><div class="line">| ```starts```        | ```Event``` 開始時間 (第一次開始執行的時間)           |</div><div class="line">| ```ends```          | ```Event``` 結束時間 (如果沒有結束日期就是 Null)      |</div><div class="line"></div><div class="line">要注意的是 ```last_executed``` 是不管成功或是失敗執行完的時間，```starts``` 是第一次執行的時間，如果他是週期性執行，沒有結束的時間，只會記住第一次的</div><div class="line"></div><div class="line">這個時間系統很重要的是因為它會關係到後續報表怎麼出，所以要先了解一下</div><div class="line"></div><div class="line">另外的是處理情形的資訊，在 ```mysql.event``` 沒有任何紀錄最後一次狀態的資訊 (所以才說它幾乎是射後不理的系統)，這邊就需要自己紀錄了。 </div><div class="line"></div><div class="line">## 紀錄 ```Event``` 執行狀態的 table</div><div class="line">根據需求，我在 ```master``` Create 了 ```event_history``` 資料表</div><div class="line"></div><div class="line">```sql</div><div class="line">CREATE TABLE `event_history` (</div><div class="line">    `db` CHAR(64) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">    `name` CHAR(64) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">    `start` DATETIME NULL DEFAULT NULL,</div><div class="line">    `end` DATETIME NULL DEFAULT NULL,</div><div class="line">    `sqlstate` CHAR(64) NULL DEFAULT NULL,</div><div class="line">    `errno` CHAR(64) NULL DEFAULT NULL,</div><div class="line">    `message_text` VARCHAR(500) NULL DEFAULT NULL,</div><div class="line">    `record_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,</div><div class="line">    INDEX `idx1` (`db`, `name`)</div><div class="line">)</div><div class="line">COLLATE=&apos;utf8_general_ci&apos;</div><div class="line">ENGINE=InnoDB</div><div class="line">;</div><div class="line">```  </div><div class="line">|  欄位名              | 意義                                              | </div><div class="line">|---------------------|--------------------------------------------------|</div><div class="line">| ```db```            | ```mysql.event.db```                             |</div><div class="line">| ```name```          | ```mysql.event.name```                           |</div><div class="line">| ```start```         | 這次執行開始時間                                    |</div><div class="line">| ```end```           | 這次執行結束時間                                    |</div><div class="line">| ```sqlstate```      | 錯誤時紀錄 ```sqlstate```                          |</div><div class="line">| ```errno```         | 錯誤代碼                                           |</div><div class="line">| ```message_text```  | 訊息                                              |</div><div class="line">| ```record_time```   | 紀錄時間                                           |</div><div class="line"></div><div class="line">### 攔截錯誤時的訊息</div><div class="line">MariaDB 有個 [Handler](https://mariadb.com/kb/en/mariadb/declare-handler/) 作為錯誤處理 try-catch 的機制，可以從這邊下手。</div><div class="line"></div><div class="line">[Diagnostics](https://mariadb.com/kb/en/mariadb/get-diagnostics/) 可以在錯誤時拿到相關的資訊，有 ```sqlstate``` ，```errno``` ，```message_text``` 可以拿來用。</div><div class="line"></div><div class="line">### Prepare Statements</div><div class="line">由上面的準備，幾乎是可以完成表裡需要的欄位項目，但是如果要每個 ```Event```都要前面加 ```Handler``` 與 ```Diagnostics``` 來塞資料，這樣太麻煩也有可能會忘記，所以要做個 Store Procedure 來達成這個需求。</div><div class="line"></div><div class="line">其中需要讓 Store Procedure 執行傳進來的 SQL Statements，有 [Prepare Statement](https://mariadb.com/kb/en/mariadb/prepare-statement/) 可以用，這樣就差不多了</div><div class="line"></div><div class="line">不過這個 Prepare Statement 有限制使用的語法，而且只能執行一行。</div><div class="line"></div><div class="line">```sql</div><div class="line">CREATE PROCEDURE `proc_for_event_history`(IN `idb` char(64), IN `iname` char(64), IN `sql` TEXT)</div><div class="line">    LANGUAGE SQL</div><div class="line">    NOT DETERMINISTIC</div><div class="line">    CONTAINS SQL</div><div class="line">    SQL SECURITY DEFINER</div><div class="line">    COMMENT &apos;&apos;</div><div class="line">BEGIN</div><div class="line">      DECLARE EXIT HANDLER FOR SQLEXCEPTION</div><div class="line">      BEGIN</div><div class="line">        GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE,  @errno = MYSQL_ERRNO, @text = MESSAGE_TEXT;</div><div class="line">        select now() into @start from dual;</div><div class="line">        insert into master.event_history (`db`, `name`, `start`, `end`, `sqlstate`, `errno`, `message_text`) values (idb, iname, @start, now(), @sqlstate, @errno, @text);</div><div class="line">      END;</div><div class="line">     </div><div class="line">     set @sql := `sql`;</div><div class="line">     prepare stmt from @sql;</div><div class="line">    </div><div class="line">     select now() into @start from dual;</div><div class="line">     execute stmt;</div><div class="line">     select sleep(10);</div><div class="line">     insert into master.event_history (`db`, `name`, `start`, `end`, `sqlstate`, `errno`, `message_text`) values (idb, iname, @start, now(), NULL, NULL, &apos;OK&apos;);</div><div class="line"></div><div class="line">     DEALLOCATE PREPARE stmt;</div><div class="line">END</div></pre></td></tr></table></figure></p>
<p>錯誤的時候有錯誤訊息，但正確的時候不知道那邊可以找到訊息，只好先打個 OK 了。</p>
<p>有一個 <figure class="highlight plain"><figcaption><span>sleep(10);``` 是拿來做實驗用的，平時可以拿掉。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 實驗</div><div class="line"></div><div class="line">1. ```Event`` 系統要打開</div><div class="line"></div><div class="line">   ``` SET Global event_schedular=1</div></pre></td></tr></table></figure></p>
<p>   或是在 <figure class="highlight plain"><figcaption><span>加上 ```events_scheduler=1```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">2. 一個簡單 table，然後做一個 ```Event``` 是一直加一的</div><div class="line">   ```sql</div><div class="line">   CREATE Database `test1`;</div><div class="line"></div><div class="line">   CREATE TABLE `test2` (</div><div class="line">    `idtest2` int(11) NOT NULL,</div><div class="line">    PRIMARY KEY (`idtest2`)</div><div class="line">   ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">   CREATE EVENT `test_event`</div><div class="line">    ON SCHEDULE</div><div class="line">        EVERY 1 MINUTE STARTS &apos;2016-09-07 16:00:58&apos;</div><div class="line">    ON COMPLETION NOT PRESERVE</div><div class="line">    ENABLE</div><div class="line">    COMMENT &apos;&apos;</div><div class="line">    DO begin</div><div class="line">     call master.proc_for_event_history(&apos;test1&apos;, &apos;test_event&apos;, &apos;UPDATE test1.test22 SET idtest2 = idtest2 + 1&apos;);</div><div class="line">   end;</div></pre></td></tr></table></figure></p>
<p>   這裡的 <figure class="highlight plain"><figcaption><span>是故意打錯的，看看結果如何</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">3. 看一下結果</div><div class="line">```cmd</div><div class="line">MariaDB [master]&gt; select * from event_history order by record_time desc limit 1\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">          db: test1</div><div class="line">        name: test_event</div><div class="line">       start: 2016-09-10 15:57:58</div><div class="line">         end: 2016-09-10 15:57:58</div><div class="line">    sqlstate: 42S02</div><div class="line">       errno: 1146</div><div class="line">message_text: Table &apos;test1.test22&apos; doesn&apos;t exist</div><div class="line"> record_time: 2016-09-10 15:57:58</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<ol>
<li>調回來正確的，再看一下結果<figure class="highlight cmd"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">MariaDB [master]&gt; select * from event_history order by record_time desc limit <span class="number">1</span>\G</div><div class="line">*************************** <span class="number">1</span>. row ***************************</div><div class="line"><span class="function">          db: <span class="title">test1</span></span></div><div class="line">        <span class="title">name</span>: <span class="title">test_event</span></div><div class="line">       <span class="title">start</span>: 2016-09-10 16:00:58</div><div class="line">         <span class="title">end</span>: 2016-09-10 16:01:08</div><div class="line">    <span class="title">sqlstate</span>: <span class="title">NULL</span></div><div class="line">       <span class="title">errno</span>: <span class="title">NULL</span></div><div class="line"><span class="title">message_text</span>: <span class="title">OK</span></div><div class="line"> <span class="title">record_time</span>: 2016-09-10 16:01:08</div><div class="line">1 <span class="title">row</span> <span class="title">in</span> <span class="title">set</span> (0.00 <span class="title">sec</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>開始跟結束差 10 秒鐘是之前加的 <code>select sleep(10)</code> 的關係。</p>
<h2 id="還需要解決的項目"><a href="#還需要解決的項目" class="headerlink" title="還需要解決的項目"></a>還需要解決的項目</h2><ol>
<li>Query 正確時的回傳要能抓到</li>
<li>該次真正開始執行時間</li>
<li>下一次開始執行時間</li>
</ol>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2016/09/10/從 SQL Server 到 MariaDB - [4] SQL Agent 與 MariaDB Event/';
var disqus_title = '從 SQL Server 到 MariaDB - [4] SQL Agent 與 MariaDB Event';
var disqus_url = 'https://sujunmin.github.io/blog/blog/2016/09/10/從 SQL Server 到 MariaDB - [4] SQL Agent 與 MariaDB Event/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>