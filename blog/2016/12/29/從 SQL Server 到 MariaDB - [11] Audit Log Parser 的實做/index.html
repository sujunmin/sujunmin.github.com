<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>從 SQL Server 到 MariaDB - [11] Audit Log Parser 的實做 | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script><link rel="stylesheet" href="/blog/css/prism.css" type="text/css">
<link rel="stylesheet" href="/blog/css/prism-line-numbers.css" type="text/css"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>從 SQL Server 到 MariaDB - [11] Audit Log Parser 的實做</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-12-29</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a>/<a class="post-tag-link" href="/blog/tags/MariaDB/">MariaDB</a></div></div></div><article><div class="container post"><h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>因為公司的稽核項目很多，所以大部分的專案都會買一些 SIEM 的設備 (Arcsight, 趨勢的平台…)，有的時候很好用，但是有的時候太複雜或是很慢，所以就有自己作 Audit Log Parser 的動機。</p>
<p>對於 SQL Server 的 Audit Log (Trace File)有個自己作的 <a href="https://github.com/sujunmin/SQLServerTraceFileParser" target="_blank" rel="noopener">Parser</a>，對於 MariaDB 應該也要有一樣的方式處理。</p>
<h2 id="基本架構"><a href="#基本架構" class="headerlink" title="基本架構"></a>基本架構</h2><p>我的環境除了正式機以外，還有備援機 (Slave)，原來是想在備援機上的 relayed binlog 來作處理，結果大失所望。那些從 master relayed 來的 binlog 完全不會有<a href="https://jira.mariadb.org/browse/MDEV-11618" target="_blank" rel="noopener">紀錄</a>，這樣就不能從備援機正式機的 Audit Log 了。</p>
<p>我的 SQL Server 正式機因為怕效能損耗不會在正式機上 Parsing Trace Files，而是把資料透過網芳存到備援機，由備援機來 Parsing，那 MariaDB 可不可以這樣做呢?</p>
<p>答案是可以的。</p>
<p>在 <code>server_audit_file_path</code> 設定 <code>////remotehost//dir//audit.log</code> 這樣就能達到遠端存資料了 (記得反斜線的數量)。</p>
<p>接下就是設計的問題。仍然使用好用的 Powershell 來達成目標。</p>
<p>架構大概是這樣</p>
<ul>
<li>先前處理<ul>
<li>建立相關資料夾與環境</li>
<li>匯入 log</li>
<li>分析 log</li>
<li>如有重要資料需儲存的需放到資料庫</li>
<li>如有重要資料需要即時告警的需發送</li>
</ul>
</li>
</ul>
<p>接下來就來介紹如何分析與處理。</p>
<h2 id="Audit-Log-的過程與實做"><a href="#Audit-Log-的過程與實做" class="headerlink" title="Audit Log 的過程與實做"></a>Audit Log 的過程與實做</h2><p>首先從<a href="https://mariadb.com/kb/en/mariadb/about-the-mariadb-audit-plugin/" target="_blank" rel="noopener">官方文件</a>可以看到結構。</p>
<pre><code>[timestamp],[serverhost],[username],[host],[connectionid],[queryid],[operation],[database],[object],[retcode]
</code></pre><p>有這些資料就能分析了(以下可能有更好的解法，這個<a href="https://github.com/sujunmin/MariaDBAuditFileParser/blob/master/TraceFileParser.ps1" target="_blank" rel="noopener">解法</a>只是其中一種)。</p>
<h3 id="以-timestamp-分段"><a href="#以-timestamp-分段" class="headerlink" title="以 [timestamp], 分段"></a>以 <code>[timestamp],</code> 分段</h3><p>因為檔案不是用 <code>\r\n</code> 或 <code>\n</code> 來分隔一行，而是用空白，在<code>[timestamp]</code> 與 <code>[object]</code> 也會有空白，所以需要先分段。透過 <code>[timestamp],</code> 來分段。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$matches</span> = <span class="token punctuation">(</span><span class="token namespace">[regex]</span> <span class="token string">'(\d{4})(\d{2})(\d{2}) (\d{2}):(\d{2}):(\d{2}),'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Matches<span class="token punctuation">(</span><span class="token variable">$auditfilecontent</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="每一段以-分欄位"><a href="#每一段以-分欄位" class="headerlink" title="每一段以 , 分欄位"></a>每一段以 <code>,</code> 分欄位</h3><p>接下來就是每一個 <code>,</code> 欄位，到 <code>[object]</code> 前都是這樣分的。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$submatches</span> = <span class="token punctuation">(</span><span class="token namespace">[regex]</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Matches<span class="token punctuation">(</span><span class="token variable">$line</span><span class="token punctuation">)</span>  
<span class="token variable">$timestamp</span>    = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span>0<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token punctuation">)</span>
<span class="token variable">$serverhost</span>   = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$username</span>     = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$hosts</span>        = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>3<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$connectionid</span> = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>3<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>4<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>3<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$queryid</span>      = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>4<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>5<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>4<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$operation</span>    = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>5<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>6<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>5<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$database</span>     = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>6<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>7<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>6<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span>
<span class="token variable">$retcode</span>      = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span><span class="token variable">$submatches</span><span class="token punctuation">.</span>Count<span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>1<span class="token punctuation">,</span><span class="token variable">$line</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span><span class="token variable">$submatches</span><span class="token punctuation">.</span>Count<span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">.</span>Trim<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到了 <code>[object]</code>，因為有可能裡頭也有 <code>,</code> 所以不能直接拿 <code>split</code> 的值來用，取最後一個 <code>,</code> 之前的當作是 <code>[object]</code>。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span><span class="token variable">$submatches</span><span class="token punctuation">.</span>Count<span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>7<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span> 3 <span class="token operator">-lt</span> 0<span class="token punctuation">)</span> 
 <span class="token punctuation">{</span>
   <span class="token variable">$object</span> = <span class="token string">""</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span>
 <span class="token punctuation">{</span>
   <span class="token variable">$object</span> = <span class="token variable">$line</span><span class="token punctuation">.</span>SubString<span class="token punctuation">(</span><span class="token variable">$submatches</span><span class="token punctuation">[</span>7<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">+</span>2<span class="token punctuation">,</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span><span class="token variable">$submatches</span><span class="token punctuation">.</span>Count<span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">.</span>Index <span class="token operator">-</span> <span class="token variable">$submatches</span><span class="token punctuation">[</span>7<span class="token punctuation">]</span><span class="token punctuation">.</span>Index<span class="token operator">-</span>3<span class="token punctuation">)</span>  
 <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了資料就能作其他用途了。</p>
<h2 id="處理的方式"><a href="#處理的方式" class="headerlink" title="處理的方式"></a>處理的<a href="https://github.com/sujunmin/MariaDBAuditFileParser/blob/master/TraceFileParser.ps1" target="_blank" rel="noopener">方式</a></h2><p>基本上的需求如下</p>
<ul>
<li>原始資料保存</li>
<li>人員使用的帳號(客服或帳務處理)作業需在每日統計報表裡呈現</li>
<li>資料庫管理者使用的帳號作業需在每日統計報表裡呈現</li>
<li>DCL 與 DDL 作業時需即時發送通知給主管</li>
<li>每日使用狀態報表</li>
</ul>
<h3 id="重要資料紀錄-DB"><a href="#重要資料紀錄-DB" class="headerlink" title="重要資料紀錄 DB"></a>重要資料紀錄 DB</h3><p>針對可得到的資料要作一個<a href="https://github.com/sujunmin/MariaDBAuditFileParser/blob/master/auditdb.sql" target="_blank" rel="noopener">紀錄</a>，用資料庫處理。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>auditdb<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">USE</span> <span class="token punctuation">`</span>auditdb<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>auditdata<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span><span class="token keyword">timestamp</span><span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>serverhost<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>hosts<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>connectionid<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>queryid<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>operation<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">database</span><span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>object<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retcode<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="相關人員帳號使用情形紀錄"><a href="#相關人員帳號使用情形紀錄" class="headerlink" title="相關人員帳號使用情形紀錄"></a>相關人員帳號使用情形紀錄</h3><p>看 <code>[username]</code> 欄位即可得到資訊。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$Users</span> <span class="token operator">-contains</span> <span class="token variable">$username</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$sql</span> = <span class="token string">"INSERT INTO "</span> <span class="token operator">+</span> <span class="token variable">$AuditDB</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> <span class="token variable">$TraceFileData</span> <span class="token operator">+</span> <span class="token string">" VALUES (STR_TO_DATE('"</span> <span class="token operator">+</span> <span class="token variable">$timestamp</span> <span class="token operator">+</span> <span class="token string">"','%Y%m%d %H:%i:%S'), '"</span> <span class="token operator">+</span> <span class="token variable">$serverhost</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$username</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$hosts</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$connectionid</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$queryid</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$operation</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$database</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$object</span> <span class="token operator">+</span> <span class="token string">"', '"</span> <span class="token operator">+</span> <span class="token variable">$retcode</span> <span class="token operator">+</span><span class="token string">"');"</span>    
                    &amp; <span class="token variable">$mysqlexe</span> <span class="token operator">-</span>u <span class="token variable">$AuditDBUserName</span> <span class="token operator">--</span>password=<span class="token variable">$AuditDBPassword</span> <span class="token operator">-</span>h <span class="token variable">$AuditDBServer</span>  <span class="token operator">-</span>e <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span></span>"</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="DCL-與-DDL-作業即時告警"><a href="#DCL-與-DDL-作業即時告警" class="headerlink" title="DCL 與 DDL 作業即時告警"></a>DCL 與 DDL 作業即時告警</h3><p>如果 <code>server_audit.dll</code> 是用<a href="https://sujunmin.github.io/blog/2016/10/03/%E5%BE%9E%20SQL%20Server%20%E5%88%B0%20MariaDB%20-%20[6]%20Audit%20%E7%9A%84%E5%AF%A6%E4%BD%9C/">之前</a>說的方式重新作一個，這邊就很簡單：看 <code>[operation]</code> 是不是 <code>QUERY_DCL</code>，<code>QUERY_DML</code>，<code>QUERY_DDL</code> 就可以了。如果不是用之前的方式，這邊就要分析 <code>[object]</code> 裡頭的內容了。</p>
<p>把所需的資料放到一個 <code>ArrayList</code> 裡，全部都 Parsing 完以後看看是不是有資料，有的話就發信告警。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$MailEventClasses</span> <span class="token operator">-contains</span> <span class="token variable">$operation</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$DXL</span><span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$timestamp</span><span class="token punctuation">,</span> <span class="token variable">$serverhost</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$hosts</span><span class="token punctuation">,</span> <span class="token variable">$connectionid</span><span class="token punctuation">,</span> <span class="token variable">$queryid</span><span class="token punctuation">,</span> <span class="token variable">$operation</span><span class="token punctuation">,</span> <span class="token variable">$database</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$retcode</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$DXL</span><span class="token punctuation">.</span>Count <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$output</span> = <span class="token string">"&lt;table border=1 style=border-width: thin; border-spacing: 2px; border-style: solid; border-color: gray; border-collapse: collapse;> 
                 &lt;tr>&lt;th>StartTime&lt;/th>
             &lt;th>LoginName&lt;/th>
                 &lt;th>HostName&lt;/th>
             &lt;th>ServerName&lt;/th>
                 &lt;th>DatabaseName&lt;/th>
                 &lt;th>Operation&lt;/th>
                     &lt;th>TextData&lt;/th>
                     &lt;th>ReturnCode&lt;/th>&lt;/tr>"</span>

        <span class="token variable">$DXL</span> <span class="token punctuation">|</span> <span class="token function">Foreach-Object</span> <span class="token punctuation">{</span>

        <span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token string">"&lt;tr>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span>  <span class="token variable">$_</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>3<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>7<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>6<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>8<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$_</span><span class="token punctuation">[</span>9<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;/tr>"</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token string">"&lt;/table>"</span>
    <span class="token function">Send-MailMessage</span> <span class="token operator">-</span>To <span class="token variable">$MailTo</span> <span class="token operator">-</span><span class="token keyword">From</span> <span class="token variable">$MailFrom</span> <span class="token operator">-</span>Subject <span class="token string">"資料庫特權活動即時告警"</span> <span class="token operator">-</span>Body <span class="token string">"<span class="token variable">$output</span>"</span> <span class="token operator">-</span>BodyAsHtml <span class="token operator">-</span>SmtpServer <span class="token variable">$MailServer</span> <span class="token operator">-</span>Encoding <span class="token punctuation">(</span><span class="token namespace">[System.Text.Encoding]</span>::UTF8<span class="token punctuation">)</span>        
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="每日匯總報表"><a href="#每日匯總報表" class="headerlink" title="每日匯總報表"></a>每日匯總報表</h2><p>如果之前的作法中，塞資料到資料庫的動作有作的話，這邊就十分簡單。</p>
<p>先設定一些資料。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$AuditDBServer</span> = <span class="token string">"server"</span>
<span class="token variable">$AuditDB</span> = <span class="token string">"AuditDB"</span>
<span class="token variable">$TraceFileData</span> = <span class="token string">"auditdata"</span>
<span class="token variable">$AuditDBUserName</span> = <span class="token string">"username"</span>
<span class="token variable">$AuditDBPassword</span> = <span class="token string">"password"</span>
<span class="token variable">$mysqlexe</span> = <span class="token string">"D:\Program Files\MariaDB 10.1\bin\mysql.exe"</span>
<span class="token variable">$Users</span> = <span class="token string">"'need','to','be','audit','users'"</span>
<span class="token variable">$MailFrom</span> = <span class="token string">"from@abc.com"</span>
<span class="token variable">$MailEventClasses</span> = <span class="token string">"'QUERY_DDL','QUERY_DCL'"</span>
<span class="token variable">$MailTo</span> = <span class="token string">"to@def.com"</span>
<span class="token variable">$MailServer</span> = <span class="token string">"smtp.server"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下來移除 Audit 資料庫裡頭 3 天前的資料。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$NowTime</span> = <span class="token function">Get-Date</span>
<span class="token variable">$TempPath</span> = <span class="token string">"D:\AuditFile"</span>

<span class="token variable">$sql</span> = <span class="token string">"delete from "</span> <span class="token operator">+</span> <span class="token variable">$AuditDB</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> <span class="token variable">$TraceFileData</span> <span class="token operator">+</span> <span class="token string">" where timestamp &lt; '"</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">.</span>AddDays<span class="token punctuation">(</span><span class="token operator">-</span>3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"' or timestamp is Null;"</span>
&amp; <span class="token variable">$mysqlexe</span> <span class="token operator">-</span>u <span class="token variable">$AuditDBUserName</span> <span class="token operator">--</span>password=<span class="token variable">$AuditDBPassword</span> <span class="token operator">-</span>h <span class="token variable">$AuditDBServer</span>  <span class="token operator">-</span>e <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span></span>"</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>符合 <code>$MailEventClasses</code> 的列出來，作為每日資料庫系統設定異動報表。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$output</span> = <span class="token string">"&lt;table border=1 style=border-width: thin; border-spacing: 2px; border-style: solid; border-color: gray; border-collapse: collapse;>  
                 &lt;tr>&lt;th>StartTime&lt;/th>
             &lt;th>LoginName&lt;/th>
                 &lt;th>HostName&lt;/th>
             &lt;th>ServerName&lt;/th>
                 &lt;th>DatabaseName&lt;/th>
                 &lt;th>Operation&lt;/th>
                     &lt;th>TextData&lt;/th>
                     &lt;th>ReturnCode&lt;/th>&lt;/tr>"</span>

<span class="token variable">$sql</span>  = <span class="token string">"select '&lt;tr>&lt;td>', ``timestamp``, '&lt;/td>&lt;td>', ``username`` , '&lt;/td>&lt;td>', ``hosts``, '&lt;/td>&lt;td>', ``serverhost`` , '&lt;/td>&lt;td>', ``database`` , '&lt;/td>&lt;td>', ``operation`` , '&lt;/td>&lt;td>', ``object``, '&lt;/td>&lt;td>', ``retcode`` , '&lt;/td>&lt;/tr>' from "</span> <span class="token operator">+</span> <span class="token variable">$AuditDB</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> <span class="token variable">$TraceFileData</span> <span class="token operator">+</span> <span class="token string">" where operation in ("</span> <span class="token operator">+</span> <span class="token variable">$MailEventClasses</span> <span class="token operator">+</span> <span class="token string">") and timestamp between STR_TO_DATE('"</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">.</span>AddDays<span class="token punctuation">(</span><span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"', '%Y-%m-%d')  and STR_TO_DATE('"</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"', '%Y-%m-%d')"</span>
<span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token punctuation">(</span>&amp; <span class="token variable">$mysqlexe</span> <span class="token operator">-</span>u <span class="token variable">$AuditDBUserName</span> <span class="token operator">--</span>password=<span class="token variable">$AuditDBPassword</span> <span class="token operator">-</span>h <span class="token variable">$AuditDBServer</span> <span class="token operator">-</span>sN <span class="token operator">-</span>e <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span></span>"</span> <span class="token punctuation">)</span> 
<span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token string">"&lt;/table>"</span>

<span class="token variable">$Subj</span> = $<span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">.</span>AddDays<span class="token punctuation">(</span><span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 每日資料庫系統設定異動報表"</span>
<span class="token function">Send-MailMessage</span> <span class="token operator">-</span>To <span class="token variable">$MailTo</span> <span class="token operator">-</span><span class="token keyword">From</span> <span class="token variable">$MailFrom</span> <span class="token operator">-</span>Subject <span class="token string">"<span class="token variable">$Subj</span>"</span>  <span class="token operator">-</span>Body <span class="token string">"<span class="token variable">$output</span>"</span> <span class="token operator">-</span>BodyAsHtml  <span class="token operator">-</span>SmtpServer <span class="token variable">$MailServer</span> <span class="token operator">-</span>Encoding <span class="token punctuation">(</span><span class="token namespace">[System.Text.Encoding]</span>::UTF8<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>符合 <code>$Users</code> 的列出來，作為每日資料庫使用者使用情形報表。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$output</span> = <span class="token string">"&lt;table border=1 style=border-width: thin; border-spacing: 2px; border-style: solid; border-color: gray; border-collapse: collapse;>  
                 &lt;tr>&lt;th>StartTime&lt;/th>
             &lt;th>LoginName&lt;/th>
                 &lt;th>HostName&lt;/th>
             &lt;th>ServerName&lt;/th>
                 &lt;th>DatabaseName&lt;/th>
                 &lt;th>Operation&lt;/th>
                     &lt;th>TextData&lt;/th>
                     &lt;th>ReturnCode&lt;/th>&lt;/tr>"</span>

<span class="token variable">$sql</span>  = <span class="token string">"select '&lt;tr>&lt;td>', ``timestamp``, '&lt;/td>&lt;td>', ``username`` , '&lt;/td>&lt;td>', ``hosts``, '&lt;/td>&lt;td>', ``serverhost`` , '&lt;/td>&lt;td>', ``database`` , '&lt;/td>&lt;td>', ``operation`` , '&lt;/td>&lt;td>', ``object``, '&lt;/td>&lt;td>', ``retcode`` , '&lt;/td>&lt;/tr>' from "</span> <span class="token operator">+</span> <span class="token variable">$AuditDB</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> <span class="token variable">$TraceFileData</span> <span class="token operator">+</span> <span class="token string">" where username in ("</span> <span class="token operator">+</span> <span class="token variable">$Users</span> <span class="token operator">+</span> <span class="token string">") and timestamp between STR_TO_DATE('"</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">.</span>AddDays<span class="token punctuation">(</span><span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"', '%Y-%m-%d')  and STR_TO_DATE('"</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"', '%Y-%m-%d')"</span>
<span class="token variable">$sql</span>
<span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token punctuation">(</span>&amp; <span class="token variable">$mysqlexe</span> <span class="token operator">-</span>u <span class="token variable">$AuditDBUserName</span> <span class="token operator">--</span>password=<span class="token variable">$AuditDBPassword</span> <span class="token operator">-</span>h <span class="token variable">$AuditDBServer</span> <span class="token operator">-</span>sN <span class="token operator">-</span>e <span class="token string"><span class="token function">"$<span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span></span>"</span> <span class="token punctuation">)</span> 
<span class="token variable">$output</span> = <span class="token variable">$output</span> <span class="token operator">+</span> <span class="token string">"&lt;/table>"</span>


<span class="token variable">$Subj</span> = $<span class="token punctuation">(</span><span class="token string">"{0:yyyy-MM-dd}"</span> <span class="token operator">-</span>f <span class="token variable">$NowTime</span><span class="token punctuation">.</span>AddDays<span class="token punctuation">(</span><span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 每日資料庫使用者使用情形報表"</span>
<span class="token function">Send-MailMessage</span> <span class="token operator">-</span>To <span class="token variable">$MailTo</span> <span class="token operator">-</span><span class="token keyword">From</span> <span class="token variable">$MailFrom</span> <span class="token operator">-</span>Subject <span class="token string">"<span class="token variable">$Subj</span>"</span>  <span class="token operator">-</span>Body <span class="token string">"<span class="token variable">$output</span>"</span> <span class="token operator">-</span>BodyAsHtml  <span class="token operator">-</span>SmtpServer <span class="token variable">$MailServer</span> <span class="token operator">-</span>Encoding <span class="token punctuation">(</span><span class="token namespace">[System.Text.Encoding]</span>::UTF8<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2016/12/29/從 SQL Server 到 MariaDB - [11] Audit Log Parser 的實做/';
var disqus_title = '從 SQL Server 到 MariaDB - [11] Audit Log Parser 的實做';
var disqus_url = 'https://sujunmin.github.io/blog/2016/12/29/從 SQL Server 到 MariaDB - [11] Audit Log Parser 的實做/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunmin_" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>