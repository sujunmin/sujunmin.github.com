<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>從 SQL Server 到 MariaDB - [9] DBA Daily Check Report 的製作 [1] | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>從 SQL Server 到 MariaDB - [9] DBA Daily Check Report 的製作 [1]</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-12-27</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a>/<a class="post-tag-link" href="/blog/tags/MariaDB/">MariaDB</a></div></div></div><article><div class="container post"><h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>(這篇與下一篇是因為參加 <a href="http://ithelp.ithome.com.tw/users/20103536/ironman" target="_blank" rel="noopener">2017 iT 邦幫幫忙鐵人賽</a>而產生的，原來是沒有那麼快要開始作，但是因為沒稿子了就只能趕快做出來，分享給大家)</p>
<p>在 SQL Server 與 Oracle DB 都有一個 Daily Check Scripts 來讓我在上班開始的時候作一些自主檢查，並且產出報告，這個對於管理多台機器較為方便。</p>
<p>在 SQL Server 上我採用<a href="http://www.wisesoft.co.uk/articles/dba_daily_checks_email_report.aspx" target="_blank" rel="noopener">這個</a> Scripts， Oracle DB 的部份採用<a href="https://github.com/sujunmin/OracleDBDailyCheckScripts" target="_blank" rel="noopener">這個</a>，十分方便，很多東西都能顯示，大部分的問題都能夠馬上發現。</p>
<p>到了 MariaDB 希望能夠 Porting 這個來方便管理。</p>
<p>接下來針對這個 <a href="https://github.com/sujunmin/MariaDBDailyCheckScripts" target="_blank" rel="noopener">Porting</a> 來說明過程</p>
<ul>
<li>PowerShell 基礎架構</li>
<li>Uptime and Version</li>
<li>Disk Drive Status</li>
<li>Backup Status</li>
<li>Event Status</li>
<li>Fail Events Status</li>
<li>Database File Status</li>
<li>Session List</li>
<li>Replication Status</li>
</ul>
<h3 id="PowerShell-基礎架構"><a href="#PowerShell-基礎架構" class="headerlink" title="PowerShell 基礎架構"></a>PowerShell 基礎架構</h3><p>在作這個 Porting 之前，筆者先到 Google 找有沒有人有不錯的類似 Solution，大部分都是走 Shell Scripts，因為在 Windows 上用 PowerShell 比較方便，就決定用 PowerShell 來兜 Solution 了。</p>
<p>大致上的架構是這樣</p>
<ul>
<li>變數設定</li>
<li>Html 的頭(CSS, JS…)<ul>
<li>mysql 執行各項的子 SQL</li>
<li>將結果放到 out.html</li>
<li>Html = Html + out.html</li>
<li>執行各項作業</li>
</ul>
</li>
<li>全部都執行完畢後，整理一下寄信給相關人員</li>
</ul>
<h3 id="Uptime-and-Version"><a href="#Uptime-and-Version" class="headerlink" title="Uptime and Version"></a>Uptime and Version</h3><p>Uptime 部份，從 <code>information_schema.GLOBAL_STATUS</code> 可以得到資料，接下來整理一下，化成需要的輸出。</p>
<p></p><p class="code-caption" data-lang="sql" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><p></p>
<pre><code class="sql">SELECT CONCAT(CASE WHEN CAST(VARIABLE_VALUE as unsigned integer) &lt; @UptimeCritical * 60 THEN &#39;&lt;span class=&quot;Critical&quot;&gt;&#39;
                   WHEN CAST(VARIABLE_VALUE as unsigned integer) &lt; @UptimeWarning * 60 THEN &#39;&lt;span class=&quot;Warning&quot;&gt;&#39;
           ELSE &#39;&lt;span class=&quot;Healthy&quot;&gt;&#39; END,
FLOOR(HOUR(SEC_TO_TIME(VARIABLE_VALUE)) / 24), &#39; day(s), &#39;,
MOD(HOUR(SEC_TO_TIME(VARIABLE_VALUE)), 24), &#39; hour(s), &#39;,
MINUTE(SEC_TO_TIME(VARIABLE_VALUE)), &#39; minute(s)&lt;/span&gt;&#39;)
from information_schema.GLOBAL_STATUS where VARIABLE_NAME=&#39;UPTIME&#39;;
</code></pre>
<p>Version 部份，從系統參數就能知道了。</p>
<p></p><p class="code-caption" data-lang="sql" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><p></p>
<pre><code class="sql">SELECT @@version from dual;
</code></pre>
<h3 id="Disk-Drives"><a href="#Disk-Drives" class="headerlink" title="Disk Drives"></a>Disk Drives</h3><p>這部份需要用的 Powershell 的 <code>get-wmiobject</code> 功能。</p>
<p></p><p class="code-caption" data-lang="powershell" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><p></p>
<pre><code class="powershell">$Disks = get-wmiobject -Class win32_logicaldisk -Filter &quot;DriveType=&#39;3&#39;&quot;
</code></pre>
<p>接下就是計算大小，如果低於警告或是危險級就用不一樣的顏色標示。</p>
<p></p><p class="code-caption" data-lang="powershell" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><p></p>
<pre><code class="powershell">if (($d.FreeSpace / $d.Size * 100) -lt $FreeDiskSpacePercentCriticalThreshold) {$Html = $Html + &quot;&lt;div class=&quot;&quot;Critical&quot;&quot;&gt;&quot; + (&quot;{0:N2}&quot; -f ($d.FreeSpace / $d.Size * 100))+ &quot;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&quot;}
     elseif (($d.FreeSpace / $d.Size * 100) -lt $FreeDiskSpacePercentWarningThreshold) {$Html = $Html + &quot;&lt;div class=&quot;&quot;Warning&quot;&quot;&gt;&quot; + (&quot;{0:N2}&quot; -f ($d.FreeSpace / $d.Size * 100))+ &quot;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&quot;}
else {$Html = $Html + &quot;&lt;div class=&quot;&quot;Healthy&quot;&quot;&gt;&quot; + (&quot;{0:N2}&quot; -f ($d.FreeSpace / $d.Size * 100))+ &quot;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&quot;}
</code></pre>
<p>然後就接到原來要輸出的資料裡，這個部份就完成了。</p>
<h3 id="Backup-Status"><a href="#Backup-Status" class="headerlink" title="Backup Status"></a>Backup Status</h3><p>這個部份從系統面看不出來有跟所需要的資料有關連，但是從建立資料庫備份的檔案系統可以看得出來，因此也是用 Powershell 來完成這個需求。</p>
<table>
<thead>
<tr>
<th style="text-align:left">檔案資訊</th>
<th style="text-align:left">備份資訊</th>
<th style="text-align:left">Powershell 用法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">檔案名稱</td>
<td style="text-align:left">備份檔案名稱</td>
<td style="text-align:left"><code>$File.FullName</code></td>
</tr>
<tr>
<td style="text-align:left">建立時間</td>
<td style="text-align:left">開始備份的時間</td>
<td style="text-align:left"><code>$File.CreationTime</code></td>
</tr>
<tr>
<td style="text-align:left">修改時間</td>
<td style="text-align:left">完成備份時間</td>
<td style="text-align:left"><code>$File.LastWriteTime</code></td>
</tr>
</tbody>
</table>
<p>這邊的程式結構也是跟之前的一樣，如果有設定完整備份的資料夾，那就去看看那個資料夾狀態。</p>
<p></p><p class="code-caption" data-lang="powershell" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy="Copy Code"><span class="code-caption-label"></span><a class="code-caption-copy">Copy Code</a></p><p></p>
<pre><code class="powershell">Get-ChildItem $FullBackupPath -Filter FullBackup* |
        Foreach-Object {
       $Html = $Html + &quot;&lt;tr&gt;&lt;td&gt;&quot; + $_.FullName + &quot;&lt;/td&gt;&lt;td&gt;&quot; + $_.CreationTime + &quot;&lt;/td&gt;&lt;td&gt;&quot; + $_.LastWriteTime + &quot;&lt;/td&gt;&lt;td&gt;&quot; + (&quot;{0:N2}&quot; -f ($_.Length / 1048576)) + &quot; MB&lt;/td&gt;&lt;/tr&gt;&quot; 
}
</code></pre>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2016/12/27/從 SQL Server 到 MariaDB - [9] DBA Daily Check Report 的製作 [1]/';
var disqus_title = '從 SQL Server 到 MariaDB - [9] DBA Daily Check Report 的製作 [1]';
var disqus_url = 'https://sujunmin.github.io/blog/2016/12/27/從 SQL Server 到 MariaDB - [9] DBA Daily Check Report 的製作 [1]/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunmin_" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>