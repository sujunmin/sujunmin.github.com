<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2] | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script><link rel="stylesheet" href="/blog/css/prism-atom-dark.css" type="text/css">
<link rel="stylesheet" href="/blog/css/prism-line-numbers.css" type="text/css"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-12-27</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a>/<a class="post-tag-link" href="/blog/tags/MariaDB/">MariaDB</a></div></div></div><article><div class="container post"><h3 id="Event-Status。"><a href="#Event-Status。" class="headerlink" title="Event Status。"></a>Event Status。</h3><p>這個取得資料的方式，除了之前提到的<a href="https://sujunmin.github.io/blog/2016/09/10/%E5%BE%9E%20SQL%20Server%20%E5%88%B0%20MariaDB%20-%20[4]%20SQL%20Agent%20%E8%88%87%20MariaDB%20Event/">擴充 Event</a>  可以得到 Event 結果以外，就是系統的 <code>information_schema.EVENTS</code> 可以得到相關資訊。</p>
<h4 id="DB-Event-Name-Last-Run-Time"><a href="#DB-Event-Name-Last-Run-Time" class="headerlink" title="DB, Event Name, Last Run Time"></a>DB, Event Name, Last Run Time</h4><p>這些都能從 <code>information_schema.EVENTS</code> 拿 (<code>event_schema</code>, <code>event_name</code>, <code>last_executed</code>)。</p>
<h4 id="Event-種類"><a href="#Event-種類" class="headerlink" title="Event 種類"></a>Event 種類</h4><p>Event 種類有 <code>ENABLE</code>, <code>DISABLE</code>, <code>SLAVESIDE_DISABLED</code> (Replication 時從 Master 傳來的 Event，不會在 Slave 執行)，根據實際情形作標示。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CASE</span> <span class="token keyword">status</span> 
  <span class="token keyword">WHEN</span> <span class="token string">'ENABLED'</span> <span class="token keyword">THEN</span> <span class="token string">'&lt;div class="Healthy">Yes&lt;/div>'</span> 
  <span class="token keyword">WHEN</span> <span class="token string">'SLAVESIDE_DISABLED'</span> <span class="token keyword">THEN</span> <span class="token string">'&lt;div class="Healthy">No&lt;/div>'</span> 
  <span class="token keyword">ELSE</span> <span class="token string">'&lt;div class="Warning">No&lt;/div>'</span> 
<span class="token keyword">END</span><span class="token punctuation">,</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Succeed"><a href="#Succeed" class="headerlink" title="Succeed"></a>Succeed</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來 count，沒有 <code>errno</code> 的就是成功的。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CASE</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token operator">and</span> errno <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token keyword">WHEN</span> <span class="token number">0</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;div class="Warning">'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token operator">and</span> errno <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;/div>'</span><span class="token punctuation">)</span> 
  <span class="token keyword">ELSE</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token operator">and</span> errno <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">END</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Failed"><a href="#Failed" class="headerlink" title="Failed"></a>Failed</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來 count，有 <code>errno</code> 的就是失敗的。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CASE</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token operator">and</span> errno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token keyword">WHEN</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'&lt;div class="Healthy">0&lt;/div>'</span> 
  <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;div class="Critical">'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token operator">and</span> errno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;/div>'</span><span class="token punctuation">)</span> 
<span class="token keyword">END</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Next-Run-Time"><a href="#Next-Run-Time" class="headerlink" title="Next Run Time"></a>Next Run Time</h4><p>根據 <code>master.event</code> 可以用算的，但是算的動作不能直接傳入 column 裡頭的值 (<code>select date_add(colA, interval interval_value interval_field)...</code>)，所以寫成醜醜的 <code>CASE</code>。</p>
<p>這個部份是我覺得最沒有自動化的地方。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">case</span> interval_field
  <span class="token keyword">when</span> <span class="token string">"YEAR"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value YEAR<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"QUARTER"</span>    <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value QUARTER<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"MONTH"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value MONTH<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"DAY"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value DAY<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"HOUR"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value HOUR<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"MINUTE"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value MINUTE<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"WEEK"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value WEEK<span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token string">"SECOND"</span>        <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>last_executed<span class="token punctuation">,</span> interval interval_value SECOND<span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>(這個 interval 不是全部，我只有寫常用的)</p>
<h4 id="Last-Result"><a href="#Last-Result" class="headerlink" title="Last Result"></a>Last Result</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來看最後一次結果的內容。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">CASE</span> 
          <span class="token keyword">WHEN</span> errno <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;span class="Healthy">'</span><span class="token punctuation">,</span> message_text<span class="token punctuation">,</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">)</span> 
          <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;span class="Critical">'</span><span class="token punctuation">,</span> message_text<span class="token punctuation">,</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">)</span> 
        <span class="token keyword">END</span> 
 <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> <span class="token number">db</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_SCHEMA <span class="token operator">and</span> name <span class="token operator">=</span> ev<span class="token punctuation">.</span>EVENT_NAME <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">start</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Fail-Event"><a href="#Fail-Event" class="headerlink" title="Fail Event"></a>Fail Event</h3><p>只要看之前作的 <a href="https://sujunmin.github.io/blog/2016/09/10/%E5%BE%9E%20SQL%20Server%20%E5%88%B0%20MariaDB%20-%20[4]%20SQL%20Agent%20%E8%88%87%20MariaDB%20Event/"><code>master.event_history</code></a> 就可以了。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'&lt;tr>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token number">db</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">start</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">end</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>sqlstate<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>errno<span class="token punctuation">`</span> <span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>message_text<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>record_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token string">'&lt;/td>&lt;/tr>'</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>event_history <span class="token keyword">where</span> errno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token keyword">start</span> <span class="token operator">>=</span> subdate<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@NumDays</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Database-File-Status"><a href="#Database-File-Status" class="headerlink" title="Database File Status"></a>Database File Status</h3><p>這部份的資料可以從 <code>information_schema.tables</code> 來處理，以下為重要的欄位與說明。</p>
<table>
<thead>
<tr>
<th style="text-align:left">欄位</th>
<th style="text-align:left">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>data_length</code></td>
<td style="text-align:left">資料大小</td>
</tr>
<tr>
<td style="text-align:left"><code>index_length</code></td>
<td style="text-align:left">Index大小</td>
</tr>
<tr>
<td style="text-align:left"><code>data_free</code></td>
<td style="text-align:left">剩餘空間</td>
</tr>
</tbody>
</table>
<p>所以一個 table file 的大小 = <code>data_length</code> + <code>index_length</code> + <code>data_free</code>。<br>用掉的大小 = <code>data_length</code> + <code>index_length</code>。</p>
<p>知道這些配合一些告警就能完成了。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">'&lt;tr>&lt;td>'</span><span class="token punctuation">,</span> table_schema<span class="token punctuation">,</span> 
              <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>
              <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> concat<span class="token punctuation">(</span>@<span class="token variable">@datadir</span><span class="token punctuation">,</span> table_schema<span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span> table_name<span class="token punctuation">,</span> <span class="token string">'.*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_free<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token variable">@CriticalThresholdPCT</span> <span class="token operator">AND</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;div class="Critical">'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;/div>'</span><span class="token punctuation">)</span>
                                <span class="token keyword">WHEN</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token variable">@WarningThresholdPCT</span> <span class="token operator">AND</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;div class="Warning">'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;/div>'</span><span class="token punctuation">)</span>
                        <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span><span class="token string">'&lt;div class="Healthy">'</span><span class="token punctuation">,</span> <span class="token function">Round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>data_length <span class="token operator">+</span> index_length <span class="token operator">+</span> data_free<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;/div>'</span><span class="token punctuation">)</span> <span class="token keyword">END</span><span class="token punctuation">,</span>
              <span class="token string">'&lt;/td>&lt;/tr>'</span>
<span class="token keyword">FROM</span>   information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span> <span class="token string">'information_schema'</span><span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> table_schema<span class="token punctuation">,</span> table_name<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Session-List"><a href="#Session-List" class="headerlink" title="Session List"></a>Session List</h3><p>只要看 <code>information_schema.PROCESSLIST</code> 就可以了。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'&lt;tr>&lt;td>'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token keyword">user</span><span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> <span class="token number">db</span><span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> REPLACE<span class="token punctuation">(</span>REPLACE<span class="token punctuation">(</span>info<span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> memory_used<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;td>'</span><span class="token punctuation">,</span> query_id<span class="token punctuation">,</span> 
<span class="token string">'&lt;/td>&lt;/tr>'</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>PROCESSLIST <span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>中間的 replace 是因為用到這個 Powershell 時，也是會在 <code>information_schema.PROCESSLIST</code> 呈現的，如果沒有替換一下，就會混亂了，所以要先 escape。</p>
<h3 id="Replication-Status"><a href="#Replication-Status" class="headerlink" title="Replication Status"></a>Replication Status</h3><p>這個是說希望能在報表中知道 Slave 的基本狀況，尤其是 Slave 如果發生 Error，會卡在那邊，如果 binlog 有 expire 時間的話，太晚知道問題解決完後 binlog 因 expire 會不見，就有機會無法復原。</p>
<p>首先，先透過 <code>information_schema.GLOBAL_STATUS</code> 的 <code>SLAVE_RUNNING</code> 看該台機器是 Master 還是 Slave (在 <a href="https://github.com/sujunmin/MariaDBDailyCheckScripts/blob/master/CheckSlave.sql" target="_blank" rel="noopener"><code>CheckSlave.sql</code></a>中)</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">case</span> variable_value <span class="token keyword">when</span> <span class="token string">'ON'</span> <span class="token keyword">then</span> <span class="token string">'O'</span> <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>GLOBAL_STATUS <span class="token keyword">where</span> variable_name<span class="token operator">=</span><span class="token string">'SLAVE_RUNNING'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果是的話就是 Slave。</p>
<p>看 Slave 狀態，指令是 <code>show slave status</code> (在 <a href="https://github.com/sujunmin/MariaDBDailyCheckScripts/blob/master/ShowSlaveStatus.sql" target="_blank" rel="noopener"><code>ShowSlaveStatus.sql</code></a> 中)，但這個指令我找了很久，完全不知道是 reference 哪個 table 或是 variable，於是只能自己 Parsing 了。</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;h2>Slave Status&lt;/h2>"</span>
&amp; <span class="token variable">$mysqlexe</span> <span class="token operator">-</span>u <span class="token variable">$rptuser</span> <span class="token operator">--</span>password=<span class="token variable">$rptpass</span> <span class="token operator">-</span>h <span class="token variable">$ServerIP</span> <span class="token operator">-</span>sN <span class="token operator">-</span>e <span class="token string">"source .\ShowSlaveStatus.sql"</span> > out<span class="token punctuation">.</span>html

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">Get-Item</span> <span class="token punctuation">.</span>\out<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-gt</span> 0<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;table>
&lt;tr>
&lt;th>Master Host&lt;/th>
&lt;th>Master Log File&lt;/th>
&lt;th>Relay Master Log File&lt;/th>
&lt;th>Slave IO State&lt;/th>
&lt;th>Last Errno&lt;/th>
&lt;th>Last Error&lt;/th>
&lt;th>Last IO Errno&lt;/th>
&lt;th>Last IO Error&lt;/th>
&lt;th>Last SQL Errno&lt;/th>
&lt;th>Last SQL Error&lt;/th>
&lt;/tr>"</span>

<span class="token variable">$stat</span> = <span class="token namespace">[string[]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">Get-Content</span> <span class="token punctuation">.</span>\out<span class="token punctuation">.</span>html<span class="token punctuation">)</span>

<span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;tr>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>6<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stat</span><span class="token punctuation">[</span>19<span class="token punctuation">]</span> <span class="token operator">-eq</span> <span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>19<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>20<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span><span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>19<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;td>&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>20<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;td>"</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stat</span><span class="token punctuation">[</span>35<span class="token punctuation">]</span> <span class="token operator">-eq</span> <span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>35<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>36<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span><span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>35<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;td>&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>36<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;td>"</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stat</span><span class="token punctuation">[</span>37<span class="token punctuation">]</span> <span class="token operator">-eq</span> <span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>37<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/td>&lt;td>"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>38<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;/tr>&lt;/table>"</span><span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>37<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;td>&lt;div class="</span><span class="token string">"Critical"</span><span class="token string">">"</span> <span class="token operator">+</span> <span class="token variable">$stat</span><span class="token punctuation">[</span>38<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"&lt;/div>&lt;/td>&lt;/tr>&lt;/table>"</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token variable">$Html</span> = <span class="token variable">$Html</span> <span class="token operator">+</span> <span class="token string">"&lt;span class="</span><span class="token string">"Critical"</span><span class="token string">">No Slave Status&lt;/span>&lt;br/>"</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基本上就是分開數位子，就完成了。</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2016/12/27/從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]/';
var disqus_title = '從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]';
var disqus_url = 'https://sujunmin.github.io/blog/2016/12/27/從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunmin_" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>