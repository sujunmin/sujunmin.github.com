<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2] | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick=""><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-12-27</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a>/<a class="post-tag-link" href="/blog/tags/MariaDB/">MariaDB</a></div></div></div><article><div class="container post"><h3 id="Event-Status。"><a href="#Event-Status。" class="headerlink" title="Event Status。"></a>Event Status。</h3><p>這個取得資料的方式，除了之前提到的<a href="https://sujunmin.github.io/blog/2016/09/10/%E5%BE%9E%20SQL%20Server%20%E5%88%B0%20MariaDB%20-%20[4]%20SQL%20Agent%20%E8%88%87%20MariaDB%20Event/">擴充 Event</a>  可以得到 Event 結果以外，就是系統的 <code>information_schema.EVENTS</code> 可以得到相關資訊。</p>
<h4 id="DB-Event-Name-Last-Run-Time"><a href="#DB-Event-Name-Last-Run-Time" class="headerlink" title="DB, Event Name, Last Run Time"></a>DB, Event Name, Last Run Time</h4><p>這些都能從 <code>information_schema.EVENTS</code> 拿 (<code>event_schema</code>, <code>event_name</code>, <code>last_executed</code>)。</p>
<h4 id="Event-種類"><a href="#Event-種類" class="headerlink" title="Event 種類"></a>Event 種類</h4><p>Event 種類有 <code>ENABLE</code>, <code>DISABLE</code>, <code>SLAVESIDE_DISABLED</code> (Replication 時從 Master 傳來的 Event，不會在 Slave 執行)，根據實際情形作標示。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CASE status </span><br><span class="line">  WHEN 'ENABLED' THEN '&lt;div class="Healthy"&gt;Yes&lt;/div&gt;' </span><br><span class="line">  WHEN 'SLAVESIDE_DISABLED' THEN '&lt;div class="Healthy"&gt;No&lt;/div&gt;' </span><br><span class="line">  ELSE '&lt;div class="Warning"&gt;No&lt;/div&gt;' </span><br><span class="line"><span class="keyword">END</span>,</span><br></pre></td></tr></table></figure>
<h4 id="Succeed"><a href="#Succeed" class="headerlink" title="Succeed"></a>Succeed</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來 count，沒有 <code>errno</code> 的就是成功的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CASE (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">and</span> errno <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays)) </span><br><span class="line">  <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;div class="Warning"&gt;'</span>, (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">and</span> errno <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays)), <span class="string">'&lt;/div&gt;'</span>) </span><br><span class="line">  <span class="keyword">ELSE</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">and</span> errno <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays)) </span><br><span class="line"><span class="keyword">END</span>,</span><br></pre></td></tr></table></figure>
<h4 id="Failed"><a href="#Failed" class="headerlink" title="Failed"></a>Failed</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來 count，有 <code>errno</code> 的就是失敗的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CASE (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">and</span> errno <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays)) </span><br><span class="line">  <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="string">'&lt;div class="Healthy"&gt;0&lt;/div&gt;'</span> </span><br><span class="line">  <span class="keyword">ELSE</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;div class="Critical"&gt;'</span>, (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">and</span> errno <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays)),<span class="string">'&lt;/div&gt;'</span>) </span><br><span class="line"><span class="keyword">END</span>,</span><br></pre></td></tr></table></figure>
<h4 id="Next-Run-Time"><a href="#Next-Run-Time" class="headerlink" title="Next Run Time"></a>Next Run Time</h4><p>根據 <code>master.event</code> 可以用算的，但是算的動作不能直接傳入 column 裡頭的值 (<code>select date_add(colA, interval interval_value interval_field)...</code>)，所以寫成醜醜的 <code>CASE</code>。</p>
<p>這個部份是我覺得最沒有自動化的地方。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">case interval_field</span><br><span class="line">  when "YEAR"	    then date_add(last_executed, interval interval_value YEAR)</span><br><span class="line">  when "QUARTER"	then date_add(last_executed, interval interval_value QUARTER)</span><br><span class="line">  when "MONTH"	    then date_add(last_executed, interval interval_value MONTH)</span><br><span class="line">  when "DAY"	    then date_add(last_executed, interval interval_value DAY)</span><br><span class="line">  when "HOUR"	    then date_add(last_executed, interval interval_value HOUR)</span><br><span class="line">  when "MINUTE"	    then date_add(last_executed, interval interval_value MINUTE)</span><br><span class="line">  when "WEEK"	    then date_add(last_executed, interval interval_value WEEK)</span><br><span class="line">  when "SECOND"	    then date_add(last_executed, interval interval_value SECOND)</span><br><span class="line"><span class="keyword">end</span>,</span><br></pre></td></tr></table></figure>
<p>(這個 interval 不是全部，我只有寫常用的)</p>
<h4 id="Last-Result"><a href="#Last-Result" class="headerlink" title="Last Result"></a>Last Result</h4><p>根據 <code>master.event</code> 與 <code>information_schema.EVENTS</code> 來看最後一次結果的內容。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> <span class="keyword">CASE</span> </span><br><span class="line">          <span class="keyword">WHEN</span> errno <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">THEN</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;span class="Healthy"&gt;'</span>, message_text, <span class="string">'&lt;/span&gt;'</span>) </span><br><span class="line">          <span class="keyword">ELSE</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;span class="Critical"&gt;'</span>, message_text, <span class="string">'&lt;/span&gt;'</span>) </span><br><span class="line">        <span class="keyword">END</span> </span><br><span class="line"> <span class="keyword">from</span> master.event_history <span class="keyword">where</span> db = ev.EVENT_SCHEMA <span class="keyword">and</span> <span class="keyword">name</span> = ev.EVENT_NAME <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">start</span> <span class="keyword">limit</span> <span class="number">1</span>),</span><br></pre></td></tr></table></figure>
<h3 id="Fail-Event"><a href="#Fail-Event" class="headerlink" title="Fail Event"></a>Fail Event</h3><p>只要看之前作的 <a href="https://sujunmin.github.io/blog/2016/09/10/%E5%BE%9E%20SQL%20Server%20%E5%88%B0%20MariaDB%20-%20[4]%20SQL%20Agent%20%E8%88%87%20MariaDB%20Event/"><code>master.event_history</code></a> 就可以了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'&lt;tr&gt;&lt;td&gt;'</span>, <span class="string">`db`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`name`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`start`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`end`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`sqlstate`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`errno`</span> , <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`message_text`</span>, <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="string">`record_time`</span>, <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span> <span class="keyword">from</span> master.event_history <span class="keyword">where</span> errno <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> <span class="keyword">start</span> &gt;= <span class="keyword">subdate</span>(<span class="keyword">now</span>(), @NumDays);</span><br></pre></td></tr></table></figure>
<h3 id="Database-File-Status"><a href="#Database-File-Status" class="headerlink" title="Database File Status"></a>Database File Status</h3><p>這部份的資料可以從 <code>information_schema.tables</code> 來處理，以下為重要的欄位與說明。</p>
<table>
<thead>
<tr>
<th style="text-align:left">欄位</th>
<th style="text-align:left">說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>data_length</code></td>
<td style="text-align:left">資料大小</td>
</tr>
<tr>
<td style="text-align:left"><code>index_length</code></td>
<td style="text-align:left">Index大小</td>
</tr>
<tr>
<td style="text-align:left"><code>data_free</code></td>
<td style="text-align:left">剩餘空間</td>
</tr>
</tbody>
</table>
<p>所以一個 table file 的大小 = <code>data_length</code> + <code>index_length</code> + <code>data_free</code>。<br>用掉的大小 = <code>data_length</code> + <code>index_length</code>。</p>
<p>知道這些配合一些告警就能完成了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'&lt;tr&gt;&lt;td&gt;'</span>, table_schema, </span><br><span class="line">              <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>,table_name,</span><br><span class="line">              <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">concat</span>(@@datadir, table_schema, <span class="string">'\\'</span>, table_name, <span class="string">'.*'</span>),</span><br><span class="line">              <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">Round</span>((data_length + index_length + data_free) / <span class="number">1024</span> / <span class="number">1024</span> , <span class="number">1</span>),</span><br><span class="line"> 	      <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">Round</span>((data_length + index_length) / <span class="number">1024</span> / <span class="number">1024</span> , <span class="number">1</span>),</span><br><span class="line"> 	      <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">Round</span>((data_free) / <span class="number">1024</span> / <span class="number">1024</span> , <span class="number">1</span>),</span><br><span class="line"> 	      <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">Round</span>((data_length + index_length)/(data_length + index_length + data_free) * <span class="number">100</span> , <span class="number">2</span>) &gt; @CriticalThresholdPCT <span class="keyword">AND</span> <span class="keyword">Round</span>((data_length + index_length + data_free) / <span class="number">1024</span> / <span class="number">1024</span> , <span class="number">1</span>) &gt; <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;div class="Critical"&gt;'</span>, <span class="keyword">Round</span>((data_length + index_length)/(data_length + index_length + data_free) * <span class="number">100</span> , <span class="number">2</span>),<span class="string">'&lt;/div&gt;'</span>)</span><br><span class="line">                                <span class="keyword">WHEN</span> <span class="keyword">Round</span>((data_length + index_length)/(data_length + index_length + data_free) * <span class="number">100</span> , <span class="number">2</span>) &gt; @WarningThresholdPCT <span class="keyword">AND</span> <span class="keyword">Round</span>((data_length + index_length + data_free) / <span class="number">1024</span> / <span class="number">1024</span> , <span class="number">1</span>) &gt; <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;div class="Warning"&gt;'</span>, <span class="keyword">Round</span>((data_length + index_length)/(data_length + index_length + data_free) * <span class="number">100</span> , <span class="number">2</span>),<span class="string">'&lt;/div&gt;'</span>)</span><br><span class="line">		                <span class="keyword">ELSE</span> <span class="keyword">CONCAT</span>(<span class="string">'&lt;div class="Healthy"&gt;'</span>, <span class="keyword">Round</span>((data_length + index_length)/(data_length + index_length + data_free) * <span class="number">100</span> , <span class="number">2</span>),<span class="string">'&lt;/div&gt;'</span>) <span class="keyword">END</span>,</span><br><span class="line">              <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span></span><br><span class="line"><span class="keyword">FROM</span>   information_schema.tables <span class="keyword">where</span> table_schema <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'performance_schema'</span>, <span class="string">'mysql'</span>, <span class="string">'information_schema'</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> table_schema, table_name;</span><br></pre></td></tr></table></figure>
<h3 id="Session-List"><a href="#Session-List" class="headerlink" title="Session List"></a>Session List</h3><p>只要看 <code>information_schema.PROCESSLIST</code> 就可以了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'&lt;tr&gt;&lt;td&gt;'</span>, <span class="keyword">id</span>,</span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">user</span>, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, host, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, db, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, command, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(info,<span class="string">'&lt;'</span>,<span class="string">'&lt;'</span>), <span class="string">'&gt;'</span>, <span class="string">'&gt;'</span>),</span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, state, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, memory_used, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="built_in">time</span>, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;td&gt;'</span>, query_id, </span><br><span class="line"><span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span> <span class="keyword">from</span> information_schema.PROCESSLIST <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<p>中間的 replace 是因為用到這個 Powershell 時，也是會在 <code>information_schema.PROCESSLIST</code> 呈現的，如果沒有替換一下，就會混亂了，所以要先 escape。</p>
<h3 id="Replication-Status"><a href="#Replication-Status" class="headerlink" title="Replication Status"></a>Replication Status</h3><p>這個是說希望能在報表中知道 Slave 的基本狀況，尤其是 Slave 如果發生 Error，會卡在那邊，如果 binlog 有 expire 時間的話，太晚知道問題解決完後 binlog 因 expire 會不見，就有機會無法復原。</p>
<p>首先，先透過 <code>information_schema.GLOBAL_STATUS</code> 的 <code>SLAVE_RUNNING</code> 看該台機器是 Master 還是 Slave (在 <a href="https://github.com/sujunmin/MariaDBDailyCheckScripts/blob/master/CheckSlave.sql" target="_blank" rel="noopener"><code>CheckSlave.sql</code></a>中)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span> variable_value <span class="keyword">when</span> <span class="string">'ON'</span> <span class="keyword">then</span> <span class="string">'O'</span> <span class="keyword">else</span> <span class="string">''</span> <span class="keyword">end</span> <span class="keyword">from</span> information_schema.GLOBAL_STATUS <span class="keyword">where</span> variable_name=<span class="string">'SLAVE_RUNNING'</span>;</span><br></pre></td></tr></table></figure>
<p>如果是的話就是 Slave。</p>
<p>看 Slave 狀態，指令是 <code>show slave status</code> (在 <a href="https://github.com/sujunmin/MariaDBDailyCheckScripts/blob/master/ShowSlaveStatus.sql" target="_blank" rel="noopener"><code>ShowSlaveStatus.sql</code></a> 中)，但這個指令我找了很久，完全不知道是 reference 哪個 table 或是 variable，於是只能自己 Parsing 了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;h2&gt;Slave Status&lt;/h2&gt;"</span></span><br><span class="line">&amp; <span class="variable">$mysqlexe</span> -u <span class="variable">$rptuser</span> --password=<span class="variable">$rptpass</span> -h <span class="variable">$ServerIP</span> -sN -e <span class="string">"source .\ShowSlaveStatus.sql"</span> &gt; out.html</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="built_in">Get-Item</span> .\out.html).length <span class="nomarkup">-gt</span> <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;table&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Master Host&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Master Log File&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Relay Master Log File&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Slave IO State&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last Errno&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last Error&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last IO Errno&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last IO Error&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last SQL Errno&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;th&gt;Last SQL Error&lt;/th&gt;</span></span><br><span class="line"><span class="string">&lt;/tr&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$stat</span> = [string[]](<span class="built_in">Get-Content</span> .\out.html)</span><br><span class="line"></span><br><span class="line"><span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;tr&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">2</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">6</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">10</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">1</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$stat</span>[<span class="number">19</span>] <span class="nomarkup">-eq</span> <span class="string">"0"</span>) &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="variable">$stat</span>[<span class="number">19</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">20</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span>&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">19</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;td&gt;&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">20</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;td&gt;"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$stat</span>[<span class="number">35</span>] <span class="nomarkup">-eq</span> <span class="string">"0"</span>) &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="variable">$stat</span>[<span class="number">35</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">36</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span>&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">35</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;td&gt;&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">36</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;td&gt;"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$stat</span>[<span class="number">37</span>] <span class="nomarkup">-eq</span> <span class="string">"0"</span>) &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="variable">$stat</span>[<span class="number">37</span>] + <span class="string">"&lt;/td&gt;&lt;td&gt;"</span> + <span class="variable">$stat</span>[<span class="number">38</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</span>&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;<span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">37</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;td&gt;&lt;div class="</span><span class="string">"Critical"</span><span class="string">"&gt;"</span> + <span class="variable">$stat</span>[<span class="number">38</span>] + <span class="string">"&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable">$Html</span> = <span class="variable">$Html</span> + <span class="string">"&lt;span class="</span><span class="string">"Critical"</span><span class="string">"&gt;No Slave Status&lt;/span&gt;&lt;br/&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本上就是分開數位子，就完成了。</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2016/12/27/從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]/';
var disqus_title = '從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]';
var disqus_url = 'https://sujunmin.github.io/blog/2016/12/27/從 SQL Server 到 MariaDB - [10] DBA Daily Check Report 的製作 [2]/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunmin_" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">Su, Jun-Ming</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></html>