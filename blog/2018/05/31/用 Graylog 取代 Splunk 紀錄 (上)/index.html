<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>用 Graylog 取代 Splunk 紀錄 (上) | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script><link rel="stylesheet" href="/blog/css/prism-atom-dark.css" type="text/css">
<link rel="stylesheet" href="/blog/css/prism-line-numbers.css" type="text/css"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>用 Graylog 取代 Splunk 紀錄 (上)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2018-05-31</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MIS/">MIS</a>/<a class="post-tag-link" href="/blog/tags/Networks/">Networks</a></div></div></div><article><div class="container post"><h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>原來負責系統的 Log 架構是這樣的</p>
<p><img src="https://raw.githubusercontent.com/sujunmin/sujunmin.github.com/master/test/graylog_1.png" alt=""></p>
<p>因為 Splunk License 的關係，有時候會因為收的量太多而罷工了。</p>
<p>這次就是想要利用 <a href="https://www.graylog.org/" target="_blank" rel="noopener">Graylog</a> 來取代原有的 Splunk，以避免有 Log 沒分析到的問題。</p>
<h2 id="試用經過"><a href="#試用經過" class="headerlink" title="試用經過"></a>試用經過</h2><h1 id="請注意以下因為一些因素，只換-Splunk-的方式非真正最佳解法，僅提供有類似架構的朋友參考"><a href="#請注意以下因為一些因素，只換-Splunk-的方式非真正最佳解法，僅提供有類似架構的朋友參考" class="headerlink" title="(請注意以下因為一些因素，只換 Splunk 的方式非真正最佳解法，僅提供有類似架構的朋友參考)"></a>(請注意以下因為一些因素，只換 Splunk 的方式非真正最佳解法，僅提供有類似架構的朋友參考)</h1><p>因為一開始對 Graylog 不熟，所以當然要有一些測試。從官網上的 <a href="http://docs.graylog.org/en/latest/pages/installation/virtual_machine_appliances.html" target="_blank" rel="noopener">OVA</a> 開始，發現可以有 Log 進來，玩了一下界面，還蠻不錯的。</p>
<p>不過有一個麻煩的事情(這個在之前系統有購買 Arcsight 的 Solution 也有碰到過)，就是資料是亂碼的問題。</p>
<p>原因出在從 <a href="https://www.kiwisyslog.com/kiwi-syslog-server" target="_blank" rel="noopener">KIWI Syslog Server</a> 拋出來的 Syslog 是 Windows 編碼，到 Linux 上就會變亂碼了。</p>
<p>找了一些<a href="https://community.graylog.org/t/syslog-encoding-problem/2253" target="_blank" rel="noopener">方法</a>，沒找到可以從 Graylog 直接 Conversion 的方法，只能前面加個 <a href="https://www.elastic.co/products/logstash" target="_blank" rel="noopener">logstash</a> 轉了。</p>
<p>原來想裝在官網的 OVA 裡，不過官網的 OVA 一來是 Ubuntu 14.04，系統裡的 Ubuntu 16.04 外，裝好起來效能竟然差到沒法 Parsing 資料，於是就想辦法自己裝了。</p>
<p>官網的<a href="http://docs.graylog.org/en/2.4/pages/installation/os/ubuntu.html" target="_blank" rel="noopener">手動安裝方法</a>寫得很詳細，照做就很容易完成了。</p>
<h2 id="最後架構"><a href="#最後架構" class="headerlink" title="最後架構"></a>最後架構</h2><p><img src="https://raw.githubusercontent.com/sujunmin/sujunmin.github.com/master/test/graylog_2.png" alt=""></p>
<p>因為只有 Windows 傳過來的會亂碼，所以在 Graylog 前面多放一個 logstash 轉檔以後再丟到 Graylog 即可，網路設備的不會這樣，就直接送進 Graylog。</p>
<h3 id="Graylog-Server"><a href="#Graylog-Server" class="headerlink" title="Graylog Server"></a>Graylog Server</h3><h4 id="Ubuntu-16-04"><a href="#Ubuntu-16-04" class="headerlink" title="Ubuntu 16.04"></a>Ubuntu 16.04</h4><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> upgrade
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https openjdk-8-jre-headless uuid-runtime pwgen
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>測試一下 Java</p>
<pre class="line-numbers language-bash"><code class="language-bash">sujunmin@graylog:~$ java -version
java version <span class="token string">"1.8.0_171"</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build 1.8.0_171-b01<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> 64-Bit Server VM <span class="token punctuation">(</span>build 25.171-b01, mixed mode<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h4><p>安裝最新版 MongoDB</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2930ADAE8CAF5059EE73BB4B58712A2291FA4AD5
$ <span class="token keyword">echo</span> <span class="token string">"deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.6 multiverse"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/mongodb-org-3.6.list
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y mongodb-org
$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> mongod.service
$ <span class="token function">sudo</span> systemctl restart mongod.service
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><p>Elasticsearch 要用 5.x 版的 (是說我已經有這個了，然後前面又有 logstash，差一個 Kanban 就變成 <a href="https://www.elastic.co/webinars/introduction-elk-stack" target="_blank" rel="noopener">ELK</a> 了，還要用 Graylog 嗎 XD)</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">wget</span> -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="token operator">|</span> <span class="token function">sudo</span> apt-key add -
$ <span class="token keyword">echo</span> <span class="token string">"deb https://artifacts.elastic.co/packages/5.x/apt stable main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/apt/sources.list.d/elastic-5.x.list
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> elasticsearch
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>安裝完以後記得設定檔 <code>/etc/elasticsearch/elasticsearch.yml</code> 裡頭的 <code>cluster.name</code> 要設為 <code>graylog</code>。</p>
<pre class="line-numbers language-vim"><code class="language-vim">cluster<span class="token operator">.</span>name<span class="token punctuation">:</span> graylog
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然後設定服務</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> elasticsearch.service
$ <span class="token function">sudo</span> systemctl restart elasticsearch.service
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>測試一下</p>
<pre class="line-numbers language-bash"><code class="language-bash">sujunmin@graylog:~$ curl -XGET <span class="token string">'localhost:9200/?pretty'</span>
<span class="token punctuation">{</span>
  <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"-kYzFA9"</span>,
  <span class="token string">"cluster_name"</span> <span class="token keyword">:</span> <span class="token string">"graylog"</span>,
  <span class="token string">"cluster_uuid"</span> <span class="token keyword">:</span> <span class="token string">"T3JQKehzSqmLThlVkEKPKg"</span>,
  <span class="token string">"version"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">"number"</span> <span class="token keyword">:</span> <span class="token string">"5.5.1"</span>,
    <span class="token string">"build_hash"</span> <span class="token keyword">:</span> <span class="token string">"19c13d0"</span>,
    <span class="token string">"build_date"</span> <span class="token keyword">:</span> <span class="token string">"2018-05-18T20:44:24.823Z"</span>,
    <span class="token string">"build_snapshot"</span> <span class="token keyword">:</span> false,
    <span class="token string">"lucene_version"</span> <span class="token keyword">:</span> <span class="token string">"6.6.0"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"tagline"</span> <span class="token keyword">:</span> <span class="token string">"You Know, for Search"</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><p>作為前端 Reverse Proxy 到 Graylog Web 的媒介</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> apt -y <span class="token function">install</span> nginx
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>修改設定檔</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/nginx/sites-available/default
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-vim"><code class="language-vim">server
<span class="token punctuation">{</span>
    listen <span class="token number">80</span> default_server<span class="token punctuation">;</span>
    listen <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span> default_server ipv6only<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
    server_name <span class="token operator">&lt;</span>實際 IP<span class="token operator">></span><span class="token punctuation">;</span>

    location <span class="token operator">/</span> <span class="token punctuation">{</span>
      proxy_set_header Host $http_host<span class="token punctuation">;</span>
      proxy_set_header <span class="token keyword">X</span><span class="token operator">-</span>Forwarded<span class="token operator">-</span>Host $host<span class="token punctuation">;</span>
      proxy_set_header <span class="token keyword">X</span><span class="token operator">-</span>Forwarded<span class="token operator">-</span>Server $host<span class="token punctuation">;</span>
      proxy_set_header <span class="token keyword">X</span><span class="token operator">-</span>Forwarded<span class="token operator">-</span>For $proxy_add_x_forwarded_for<span class="token punctuation">;</span>
      proxy_set_header <span class="token keyword">X</span><span class="token operator">-</span>Graylog<span class="token operator">-</span>Server<span class="token operator">-</span>URL http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>$server_name<span class="token operator">/</span>api<span class="token punctuation">;</span>
      proxy_pass       http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token operator">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>設定服務與啟動</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> graylog-server.service
$ <span class="token function">sudo</span> systemctl start graylog-server.service
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Graylog"><a href="#Graylog" class="headerlink" title="Graylog"></a>Graylog</h4><p>安裝最新版 Graylog</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">wget</span> https://packages.graylog2.org/repo/packages/graylog-2.4-repository_latest.deb
$ <span class="token function">sudo</span> dpkg -i graylog-2.4-repository_latest.deb
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> graylog-server
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>以下的設定是一定要設的</p>
<ol>
<li><code>root_username</code>，預設是 <code>admin</code>，可以改喜歡的</li>
<li><p><code>root_password_sha2</code>，root 的密碼，用以下方式產生</p>
<p> <code>echo -n yourpassword | sha256sum</code></p>
</li>
<li><p><code>password_secret</code>，其他用戶的密碼從這個資料加料產生，用以下方式產生</p>
<p> <code>pwgen -N 1 -s 96</code></p>
</li>
<li><p><code>rest_listen_uri</code>，預設是 <code>0.0.0.0:9000</code>，因為不管是 Web 還是其他應用程式，跟 Graylog 溝通都是透過 <a href="http://docs.graylog.org/en/2.4/pages/configuration/rest_api.html" target="_blank" rel="noopener">Graylog RESTFul API</a>，這個就是溝通的橋樑</p>
</li>
<li><p><code>rest_transport_uri</code>，這個通常跟上面的一樣，不一樣的部份是如果你想要 expose 這個服務到其他不同段的 IP，這邊就要特別設定再外面看到的 IP，前面 Nginx 的 <code>server_name</code> 會跟這個一樣</p>
</li>
<li><p><code>root_timezone</code> 設定時區</p>
</li>
<li><code>web_enable</code> 是 <code>true</code></li>
<li><code>web_listen_uri</code> 跟 <code>rest_listen_uri</code> 一樣</li>
</ol>
<p>設定服務與啟動</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> graylog-server.service
$ <span class="token function">sudo</span> systemctl start graylog-server.service
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>登入看看，記得把原來的預設收 514 的 syslog input 的 Port 改成 12345。</p>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><p>安裝 logstash</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> logstash
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安裝 <code>logstash-output-syslog</code> (轉換過的 syslog 吐給 Graylog)</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> /usr/share/logstash/bin/logstash-plugin <span class="token function">install</span> logstash-output-syslog
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>設定 pipeline.conf</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/logstash/conf.d/pipeline.conf
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Input 從 514 的 syslog 編碼為 CP950 (Windows) 轉到 12345，編碼是 UTF-8</p>
<pre class="line-numbers language-vim"><code class="language-vim">input <span class="token punctuation">{</span>
    syslog <span class="token punctuation">{</span>
      port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">514</span>
      codec <span class="token operator">=</span><span class="token operator">></span> plain <span class="token punctuation">{</span>
        charset <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"CP950"</span>
      <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

output <span class="token punctuation">{</span>
    syslog <span class="token punctuation">{</span>
        host <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"127.0.0.1"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">12345</span>
        codec <span class="token operator">=</span><span class="token operator">></span> plain <span class="token punctuation">{</span>
          charset <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"UTF-8"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Input 設在 514 用預設的 logstash 使用者沒法聽，所以要改啟動參數</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/logstash/startup.options
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>找到 <code>LS_USER</code> 與 <code>LS_GROUP</code> 都設成 <code>root</code></p>
<p>重新安裝設定檔</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> /usr/share/logstash/bin/system-install
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>設定服務與啟動</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token function">enable</span> logstash.service
<span class="token function">sudo</span> systemctl start logstash.service
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h2><p>安裝測試完成以後，就是原來 Splunk 的報表能夠轉移。</p>
<p>剛剛有說到所有跟 Graylog 溝通都是透過 Graylog RESTFul API 來做處理，下一篇文章就是要來說明如何透過 Graylog RESTFul API 來做簡單的報表。</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2018/05/31/用 Graylog 取代 Splunk 紀錄 (上)/';
var disqus_title = '用 Graylog 取代 Splunk 紀錄 (上)';
var disqus_url = 'https://sujunmin.github.io/blog/2018/05/31/用 Graylog 取代 Splunk 紀錄 (上)/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunmin_" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>