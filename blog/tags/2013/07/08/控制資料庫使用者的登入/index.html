<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>控制資料庫使用者的登入 | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>控制資料庫使用者的登入</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2013-07-08</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/MSSQL/">MSSQL</a></div></div></div><article><div class="container post"><script type="text/javascript" src="https://googledrive.com/host/0B6HWfJSgyadTUzBPMzhVbWN0TzQ/scripts/shCore.js">
</script> <script type="text/javascript" src="https://googledrive.com/host/0B6HWfJSgyadTUzBPMzhVbWN0TzQ/scripts/shBrushSql.js">
</script> <link href="https://googledrive.com/host/0B6HWfJSgyadTUzBPMzhVbWN0TzQ/styles/shCore.css" type="text/css" rel="stylesheet"> <link href="https://googledrive.com/host/0B6HWfJSgyadTUzBPMzhVbWN0TzQ/styles/shThemeDefault.css" type="text/css" rel="stylesheet"> <script type="text/javascript">
        SyntaxHighlighter.config.clipboardSwf = 'https://googledrive.com/host/0B6HWfJSgyadTUzBPMzhVbWN0TzQ/scripts/clipboard.swf';
        SyntaxHighlighter.all();
</script>

<p>很久沒有寫blog了，自從上次的<a href="http://blog.xuite.net/retsamsu/diary/56507473" target="_blank" rel="external">旅遊紀錄</a>。</p>
<p>最近做了比較多技術層面的東西，想想一方面也該是要回饋以外，另一方面也是怕自己忘記了(哈哈)。</p>
<p>開始來記錄一些技術的東西吧(旅遊的話就…XD)~</p>
<p>這篇是來說明控制MSSQL資料庫使用者的登入。<span style="line-height: 1.2;">&nbsp;</span></p>
<p>因為公司的資料庫有個需求，防火牆雖然已設定了內網連到資料庫的Policies，但是對於帳號本身的控管仍然較為鬆散，也就是說雖有開通防火牆連線，但是帳號的連線無法正常管控，所以要做的事情就是要讓帳號的登入受到管控。</p>
<p>網路上大部分的<a href="https://www.google.com.tw/search?q=mssql+login+trigger&amp;oq=mssql+login+trigger&amp;aqs=chrome.0.57j59l3j62l2.7585j0&amp;sourceid=chrome&amp;ie=UTF-8" target="_blank" rel="external">解法</a>都是使用Login Trigger來做處理，因此我也做了一個Login Trigger到資料庫上，以下是我的作法。</p>
<p>目標：能夠控管資料庫上的帳號(必要)，根據來源IP(必要)、使用的程式(非必要)、作業時間(AP帳號(全時暢通)或是管理用帳號(上班日可使用)，必要)來控管。</p>
<ol>
<li><span style="line-height: 1.2;">資料庫設定</span><pre class="brush: sql;">USE master
GO
GRANT SELECT ON LoginMain TO public
GO
GRANT SELECT ON LoginDate TO public
GO
</pre>

</li>
</ol>
<pre class="brush: sql;">USE master
GO
ALTER DATABASE master SET ANSI_PADDING ON
GO
ALTER DATABASE master SET CONCAT_NULL_YIELDS_NULL ON
GO
ALTER DATABASE master SET ANSI_WARNINGS ON
GO
ALTER DATABASE master SET ANSI_NULL_DEFAULT ON
GO
ALTER DATABASE master SET ANSI_NULLS ON
GO
</pre>

<ol>
<li><span style="line-height: 1.2;">加入<a href="https://googledrive.com/host/0B6HWfJSgyadTSWdfdnp3NloxcXc/Trig_Connection_Limit.sql" target="_blank" rel="external">Login Trigger</a></span></li>
</ol>
<ul>
<li><p><span style="line-height: 1.2;">執行該Script新增。</span></p>
</li>
<li><p><span style="line-height: 1.2;">這個Trigger透過Logon Event得到的</span><a href="http://technet.microsoft.com/en-us/library/hh213611.aspx" target="_blank" rel="external">XML</a><span style="line-height: 1.2;">來做判斷。</span></p>
<pre class="brush: sql;">SET @data = EVENTDATA()
SET @srcip = @data.value('(/EVENT_INSTANCE/ClientHost)[1]', 'varchar(50)')
SET @username = @data.value('(/EVENT_INSTANCE/LoginName)[1]', 'varchar(50)')
SET @LoginDate = @data.value('(/EVENT_INSTANCE/PostTime)[1]', 'datetime')</pre>
</li>
<li><p><span style="line-height: 1.2;">第一個IF免除掉不被分析的帳號(如系統帳號、Domain帳號等)。</span></p>
<pre class="brush: sql;">IF (@username NOT LIKE '%\%')&nbsp;</pre>
</li>
<li><p><span style="line-height: 1.2;">判斷式中對於帳號、程式名、IP等有限制。</span></p>
<pre class="brush: sql;">BEGIN
SELECT @lm_idx = idx FROM LoginMain WHERE username=@username AND ((CHARINDEX(@srcip,srcip) &lt;&gt; 0) OR srcip = '') AND APP_NAME() like '%'+apname+'%'
IF @lm_idx is null
BEGIN
RAISERROR ('無法在資料庫中找到您的登入帳號、來源IP、或是使用之程式不正確。',16,1)
ROLLBACK
END&nbsp;</pre>
</li>
<li><p><span style="line-height: 1.2;">接下來判斷時間是否正常。</span></p>
<pre class="brush: sql;">BEGIN      
SELECT @ld_idx = idx FROM LoginDate WHERE lm_idx = @lm_idx AND wkdnum = @wkdnum AND dfrom &lt;= lgtime="" and="" dto=""&gt;= @lgtime
IF @ld_idx is null
BEGIN
RAISERROR ('您的帳號無法在此時段登入。',16,1)
ROLLBACK
END </pre>
</li>
<li><p><span style="line-height: 1.2;">如果登入的條件未達到，就會有如同以下的訊息。</span><img src="http://e.share.photo.xuite.net/retsamsu/1e232b0/5078060/260527236_x.jpg" alt=""></p>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><span style="line-height: 1.2;">如果是帳戶名稱不對，IP不對，或是程式名稱無法配對，在SQL的記錄檔會有錯誤訊息。</span><img src="http://e.share.photo.xuite.net/retsamsu/1e232c5/5078060/260527513_x.jpg" alt=""></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><span style="line-height: 1.2;">如果是時間不對，在SQL的記錄檔會有錯誤訊息。</span><img src="http://e.share.photo.xuite.net/retsamsu/1e232db/5078060/260527535_x.jpg" alt=""></li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2013/07/08/控制資料庫使用者的登入/';
var disqus_title = '控制資料庫使用者的登入';
var disqus_url = 'https://sujunmin.github.io/blog/blog/2013/07/08/控制資料庫使用者的登入/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>