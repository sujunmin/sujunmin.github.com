<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>以前寫的關於Ruby的文章 | 隨意記事</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
 google_ad_client: "ca-pub-0187888667607442",
 enable_page_level_ads: true
 });
</script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">隨意記事</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>以前寫的關於Ruby的文章</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2009-05-19</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/Ruby/">Ruby</a></div></div></div><article><div class="container post"><p>之前作一些project的心得，大家勉強看看吧~</p>
<p>使用ruby也有一點時間了，最近大改一個之前寫的程式，發現有很多的心得，想跟之前的心得合起來記在這，供日後的參考。</p>
<p>ruby是一個日本人Yukihiro Matsumoto(matz)開發的Object-Oriented Script&nbsp;Language，在新版的RPGMaker裡可以使用ruby寫腳本。如果你已經會了perl，shell scripts，java等語言，這個東西將很容易上手(我的第一個程式就是改廠商的perl程式成ruby版本，至於為什麼要改，大概是主管對perl 的奇怪偏見吧:))。</p>
<p>以下是使用ruby 1.8(on fedora core 3)來寫作的心得。</p>
<p>一般來說跟perl的寫法幾乎一模一樣，只有一些地方不一樣(我碰到的)：<br>1. 變數前面一般來說不用加$，因為加$是global變數。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hello <span class="comment"># local variable</span></div><div class="line">$hello2 <span class="comment"># global variable</span></div><div class="line">@hello3 <span class="comment"># instance variable，可從其包含該值得object得到該值</span></div><div class="line">HELLO4 <span class="comment"># constant variable</span></div></pre></td></tr></table></figure>
<p>2. 字串裡秀變數值，或是要把值從變數拿出來時，就在變數上加上#{}就可以把值拿出來了。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">puts <span class="string">"hello: <span class="subst">#&#123;var_1&#125;</span>\n"</span> <span class="comment">#印出含var_1的字串</span></div></pre></td></tr></table></figure>
<p>3. 敘述句結束也不用加;號。</p>
<p>4. if-then-else-end，for，loop，更加的靈活。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">2000</span>.times &#123;</div><div class="line">do_something</div><div class="line">&#125; <span class="comment"># 做2000次 do_something</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> collection <span class="comment"># collection可以是一堆數字，一堆array...</span></div><div class="line">...</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>5. try-catch exception處理。使用rescue，raise等解決。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">begin</span></div><div class="line">f = File.new(<span class="string">"abc"</span>)</div><div class="line">...</div><div class="line"><span class="keyword">rescue</span></div><div class="line">puts <span class="string">"files abc can not be created.\n"</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>基本上我碰到修改與perl不同的大概就是這些。接下來就是實作程式時得到的一些心得。我把原來的perl程式改寫成了一隻multi-thread的daemon，碰到了不少問題，以下就是我的心得。</p>
<p>1. ruby連結mysql：裡面並沒內建連結mysql的函式，要去安裝ruby-mysql。<br>使用方法也很簡單，如下所示。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">begin</span></div><div class="line"><span class="keyword">require</span> <span class="string">"mysql"</span></div><div class="line">...</div><div class="line">my = Mysql::new(mysqldbhost, mysqldbuser, mysqldbpasswd, mysqldbname)</div><div class="line">res = my.query(sql_query_language)</div><div class="line">res.each <span class="keyword">do</span> <span class="params">|row|</span></div><div class="line">col1 = row[<span class="number">0</span>]</div><div class="line">col2 = row[<span class="number">1</span>]</div><div class="line">...</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>基本上我用的大部分是傳回一個hash，然後再根據名稱找值。</p>
<p>2. 建立一個daemon：用fork，loop就可以完成。加一個pid比較好控制。使用-kill<br>只會把之前的process砍掉。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 外部呼叫砍掉之前的process</span></div><div class="line"><span class="keyword">if</span> ARGV[<span class="number">0</span>] == <span class="string">"-kill"</span> <span class="keyword">then</span></div><div class="line"><span class="comment"># pidfile存在，先把之前的process砍掉</span></div><div class="line"><span class="keyword">if</span> File.exists(pidfile) <span class="keyword">then</span></div><div class="line">f = File.open(pidfile)</div><div class="line">previus_pid = f.readlines()[<span class="number">0</span>].to_i</div><div class="line">f.close</div><div class="line">Process.kill(<span class="string">"SIGHUP"</span>, previus_pid)</div><div class="line"><span class="keyword">end</span></div><div class="line">exit</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># pidfile存在，先把之前的process砍掉</span></div><div class="line"><span class="keyword">if</span> File.exists(pidfile) <span class="keyword">then</span></div><div class="line">f = File.open(pidfile)</div><div class="line">previus_pid = f.readlines()[<span class="number">0</span>].to_i</div><div class="line">f.close</div><div class="line">Process.kill(<span class="string">"SIGHUP"</span>, previus_pid)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># 寫新的pid到檔案裡</span></div><div class="line">f = File.open(pidfile, <span class="string">"w"</span>)</div><div class="line">f.write(<span class="string">"<span class="subst">#&#123;Process.pid&#125;</span>\n"</span>)</div><div class="line">f.close</div><div class="line"></div><div class="line"><span class="comment">#主程式daemon開始</span></div><div class="line">fork <span class="keyword">do</span></div><div class="line">loop <span class="keyword">do</span></div><div class="line">daemon_main_procedure</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">exit</div></pre></td></tr></table></figure>
<p>3. Thread的使用：ruby提供一系列的Thread函式，不過因為主程式沒有等其他thread做完的特性，老是主程式馬上結束了，但是其他thread沒做完(其他thread作一些IO與存取資料庫的動作)。一開始有想要用join，來等其他的thread，但是被發現這樣其實不太像thread(一個一個做)，結果使用array與while loop就可以達成。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">to_do_list = <span class="string">""</span></div><div class="line">...</div><div class="line">Thread.new()&#123;<span class="params">|t|</span></div><div class="line">to_do_list.push(t)</div><div class="line">do_thread_thing</div><div class="line">to_do_list.pop(t)</div><div class="line">&#125;</div><div class="line"><span class="keyword">while</span> to_do_list.length!=<span class="number">0</span></div><div class="line"><span class="comment"># spin lock</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>4. 使用pop3：因為我的程式有去讀信的動作，因此使用此函式，不過因為後來覺得如果使用者很多的時候pop3 server會爆掉，然後原來的程式在consistence上會有很大的問題，就用其他的方法了。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'net/pop'</span></div><div class="line">...</div><div class="line">pop = Net::POP3.new(pop3server)</div><div class="line">pop.start(pop3user, pop3passwd) <span class="keyword">do</span> <span class="params">|pop|</span></div><div class="line">msg = pop.mails[<span class="number">0</span>]</div><div class="line">header = msg.header</div><div class="line">body = msg.gsub(<span class="string">"\r\n\r\n"</span>) <span class="comment"># 兩個enter後為內文</span></div><div class="line">...</div><div class="line">pop.mails[<span class="number">0</span>].delete <span class="comment"># 砍掉mail</span></div><div class="line"><span class="keyword">end</span></div><div class="line">pop.finish</div><div class="line">..</div></pre></td></tr></table></figure>
<p>5. 因為之前4的問題，因此改採直接從本地端的mailbox(/var/mail/username)來讀信。好加在ruby有solution，差點又要回去找perl了:)這樣一來也比較快，而且不會用到pop3 server，也減少被try站的機會。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'mailread'</span></div><div class="line">...</div><div class="line">mailbox = File.open(<span class="string">"/var/mail/username"</span>)</div><div class="line"><span class="keyword">until</span> (m = Mail.new(mailbox)).header.empty?</div><div class="line">header = m. header</div><div class="line">body = m.body</div><div class="line"><span class="keyword">end</span></div><div class="line">File.truncate(<span class="string">"/var/mail/username"</span>) <span class="comment"># 砍掉mail</span></div></pre></td></tr></table></figure>
<p>最後，說一下這個ruby其實還蠻好用的，不過文件總是很亂，也沒什麼固定的<br>(我覺得的)，不過ruby-doc mailling list有人發起重新寫文件的計畫，希望能<br>寫的更好，讓programmer查的更方便。</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'sujunmin';
var disqus_identifier = '2009/05/19/以前寫的關於Ruby的文章/';
var disqus_title = '以前寫的關於Ruby的文章';
var disqus_url = 'https://sujunmin.github.io/blog/blog/2009/05/19/以前寫的關於Ruby的文章/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/sujunminx" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/sujunmin" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+JunMingSu" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">隨意記事</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-78894509-1');ga('send','pageview');</script></body></html>