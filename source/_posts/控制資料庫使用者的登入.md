---
title: 控制資料庫使用者的登入
tags:
  - MSSQL
date: 2013-07-08 09:32:21
---
很久沒有寫blog了，自從上次的[旅遊紀錄](http://blog.xuite.net/retsamsu/diary/56507473)。

最近做了比較多技術層面的東西，想想一方面也該是要回饋以外，另一方面也是怕自己忘記了(哈哈)。

開始來記錄一些技術的東西吧(旅遊的話就...XD)~

這篇是來說明控制MSSQL資料庫使用者的登入。<span style="line-height: 1.2;">&nbsp;</span>

因為公司的資料庫有個需求，防火牆雖然已設定了內網連到資料庫的Policies，但是對於帳號本身的控管仍然較為鬆散，也就是說雖有開通防火牆連線，但是帳號的連線無法正常管控，所以要做的事情就是要讓帳號的登入受到管控。

網路上大部分的[解法](https://www.google.com.tw/search?q=mssql+login+trigger&amp;oq=mssql+login+trigger&amp;aqs=chrome.0.57j59l3j62l2.7585j0&amp;sourceid=chrome&amp;ie=UTF-8)都是使用Login Trigger來做處理，因此我也做了一個Login Trigger到資料庫上，以下是我的作法。

目標：能夠控管資料庫上的帳號(必要)，根據來源IP(必要)、使用的程式(非必要)、作業時間(AP帳號(全時暢通)或是管理用帳號(上班日可使用)，必要)來控管。

1.  <span style="line-height: 1.2;">資料庫設定</span>
```sql
USE master
GO
GRANT SELECT ON LoginMain TO public
GO
GRANT SELECT ON LoginDate TO public
GO
```

```sql
USE master
GO
ALTER DATABASE master SET ANSI_PADDING ON
GO
ALTER DATABASE master SET CONCAT_NULL_YIELDS_NULL ON
GO
ALTER DATABASE master SET ANSI_WARNINGS ON
GO
ALTER DATABASE master SET ANSI_NULL_DEFAULT ON
GO
ALTER DATABASE master SET ANSI_NULLS ON
GO
```

1.  <span style="line-height: 1.2;">加入[Login Trigger](https://googledrive.com/host/0B6HWfJSgyadTSWdfdnp3NloxcXc/Trig_Connection_Limit.sql)</span>

*   <span style="line-height: 1.2;">執行該Script新增。</span>

*   <span style="line-height: 1.2;">這個Trigger透過Logon Event得到的</span>[XML](http://technet.microsoft.com/en-us/library/hh213611.aspx)<span style="line-height: 1.2;">來做判斷。</span>
```sql
SET @data = EVENTDATA()
SET @srcip = @data.value('(/EVENT_INSTANCE/ClientHost)[1]', 'varchar(50)')
SET @username = @data.value('(/EVENT_INSTANCE/LoginName)[1]', 'varchar(50)')
SET @LoginDate = @data.value('(/EVENT_INSTANCE/PostTime)[1]', 'datetime')
```

*   <span style="line-height: 1.2;">第一個IF免除掉不被分析的帳號(如系統帳號、Domain帳號等)。</span>
```sql
IF (@username NOT LIKE '%\%')
```

*   <span style="line-height: 1.2;">判斷式中對於帳號、程式名、IP等有限制。</span>
```sql
BEGIN
 SELECT @lm_idx = idx FROM LoginMain WHERE username=@username AND ((CHARINDEX(@srcip,srcip) &lt;&gt; 0) OR srcip = '') AND APP_NAME() like '%'+apname+'%'
 IF @lm_idx is null
  BEGIN
   RAISERROR ('無法在資料庫中找到您的登入帳號、來源IP、或是使用之程式不正確。',16,1)
   ROLLBACK
  END
```

*   <span style="line-height: 1.2;">接下來判斷時間是否正常。</span>
```sql
BEGIN	  
 SELECT @ld_idx = idx FROM LoginDate WHERE lm_idx = @lm_idx AND wkdnum = @wkdnum AND dfrom &lt;= lgtime="" and="" dto=""&gt;= @lgtime
IF @ld_idx is null
 BEGIN
  RAISERROR ('您的帳號無法在此時段登入。',16,1)
  ROLLBACK
END
```

*   <span style="line-height: 1.2;">如果登入的條件未達到，就會有如同以下的訊息。</span>![](http://e.share.photo.xuite.net/retsamsu/1e232b0/5078060/260527236_x.jpg)

&nbsp;

*   <span style="line-height: 1.2;">如果是帳戶名稱不對，IP不對，或是程式名稱無法配對，在SQL的記錄檔會有錯誤訊息。</span>![](http://e.share.photo.xuite.net/retsamsu/1e232c5/5078060/260527513_x.jpg)

&nbsp;

*   <span style="line-height: 1.2;">如果是時間不對，在SQL的記錄檔會有錯誤訊息。</span>![](http://e.share.photo.xuite.net/retsamsu/1e232db/5078060/260527535_x.jpg)